<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md for medfit Package • medfit</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" sizes="any" href="favicon.ico"><link rel="manifest" href="site.webmanifest"><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/Inter-0.4.10/font.css" rel="stylesheet"><link href="deps/Fira_Code-0.4.10/font.css" rel="stylesheet"><link href="deps/Montserrat-0.4.10/font.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md for medfit Package"><meta property="og:image" content="https://data-wise.github.io/medfit/logo.png"><meta name="robots" content="noindex"></head><body><p>





  pkgdown/mathjax-config.html

  

  </p>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">medfit</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="index.html" aria-label="Home"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/getting-started.html">Getting Started</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>─────────────</h6></li>
    <li><h6 class="dropdown-header" data-toc-skip>Detailed Guides</h6></li>
    <li><a class="dropdown-item" href="articles/introduction.html">Introduction to medfit</a></li>
    <li><a class="dropdown-item" href="articles/extraction.html">Model Extraction</a></li>
    <li><a class="dropdown-item" href="articles/bootstrap.html">Bootstrap Inference</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-ecosystem" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Ecosystem</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-ecosystem"><li><h6 class="dropdown-header" data-toc-skip>Core Packages</h6></li>
    <li><a class="external-link dropdown-item" href="https://data-wise.github.io/mediationverse/">mediationverse (Meta-package)</a></li>
    <li><a class="dropdown-item" href="https://data-wise.github.io/medfit/">medfit (Foundation)</a></li>
    <li><a class="external-link dropdown-item" href="https://data-wise.github.io/probmed/">probmed (P_med Effect Size)</a></li>
    <li><a class="external-link dropdown-item" href="https://data-wise.github.io/rmediation/">RMediation (Confidence Intervals)</a></li>
    <li><a class="external-link dropdown-item" href="https://data-wise.github.io/medrobust/">medrobust (Sensitivity Analysis)</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Support Packages</h6></li>
    <li><a class="external-link dropdown-item" href="https://data-wise.github.io/medsim/">medsim (Simulation Infrastructure)</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-status" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-chart-line"></span> Status</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-status"><li><a class="external-link dropdown-item" href="https://github.com/data-wise/mediationverse/blob/main/STATUS.md">Package Status Dashboard</a></li>
    <li><a class="external-link dropdown-item" href="https://data-wise.github.io/mediationverse/articles/roadmap.html">Development Roadmap</a></li>
    <li><a class="external-link dropdown-item" href="https://data-wise.github.io/mediationverse/articles/contributing.html">Contributing Guide</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">News</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/data-wise/medfit" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>CLAUDE.md for medfit Package</h1>
      <small class="dont-index">Source: <a href="https://github.com/data-wise/medfit/blob/main/CLAUDE.md" class="external-link"><code>CLAUDE.md</code></a></small>
    </div>

<div id="claudemd-for-medfit-package" class="section level1">

<p>This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.</p>
<hr><div class="section level2">
<h2 id="about-this-package">About This Package<a class="anchor" aria-label="anchor" href="#about-this-package"></a></h2>
<p><strong>medfit</strong> is a foundation package providing unified infrastructure for fitting mediation models, extracting path coefficients, and performing bootstrap inference. It eliminates redundancy across the mediation analysis ecosystem (probmed, RMediation, medrobust) by providing shared S7-based classes and methods.</p>
<div class="section level3">
<h3 id="core-mission">Core Mission<a class="anchor" aria-label="anchor" href="#core-mission"></a></h3>
<p>Provide clean, efficient, type-safe infrastructure for mediation model handling that can be shared across multiple effect size computation packages, reducing code duplication and ensuring consistency.</p>
</div>
<div class="section level3">
<h3 id="package-ecosystem-context">Package Ecosystem Context<a class="anchor" aria-label="anchor" href="#package-ecosystem-context"></a></h3>
<p><strong>medfit is the foundation for</strong>:</p>
<ol style="list-style-type: decimal"><li>
<strong>probmed</strong> - P_med (probabilistic effect size)
<ul><li>Uses medfit for: model fitting, extraction, bootstrap</li>
<li>Adds: P_med computation, visualization</li>
</ul></li>
<li>
<strong>RMediation</strong> - Confidence intervals (DOP, MBCO)
<ul><li>Uses medfit for: model extraction, bootstrap utilities</li>
<li>Adds: Distribution of Product, MBCO tests, MC methods</li>
</ul></li>
<li>
<strong>medrobust</strong> - Sensitivity analysis
<ul><li>Uses medfit for: optional naive estimates, bootstrap</li>
<li>Adds: Bounds computation, falsification tests</li>
</ul></li>
</ol><p><strong>Key Principle</strong>: medfit provides infrastructure, not effect sizes. Each dependent package focuses on its unique methodological contribution.</p>
</div>
<div class="section level3">
<h3 id="key-references">Key References<a class="anchor" aria-label="anchor" href="#key-references"></a></h3>
<ul><li>Tofighi, D. (2025). medfit: Infrastructure for mediation analysis in R. (In preparation)</li>
<li>Related: probmed, RMediation, medrobust package documentation</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="common-development-commands">Common Development Commands<a class="anchor" aria-label="anchor" href="#common-development-commands"></a></h2>
<p><strong>Preferred Tools</strong>: Use <code>devtools</code> and <code>usethis</code> packages for all R package development tasks. These provide convenient wrappers and best practices for package development workflows.</p>
<div class="section level3">
<h3 id="package-building-and-checking">Package Building and Checking<a class="anchor" aria-label="anchor" href="#package-building-and-checking"></a></h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install package dependencies</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_deps</span><span class="op">(</span>dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check package (standard R CMD check)</span></span>
<span><span class="fu">rcmdcheck</span><span class="fu">::</span><span class="fu"><a href="http://r-lib.github.io/rcmdcheck/reference/rcmdcheck.html" class="external-link">rcmdcheck</a></span><span class="op">(</span>args <span class="op">=</span> <span class="st">"--no-manual"</span>, error_on <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build package</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">build</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Install and reload during development</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">load_all</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a></h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate documentation from roxygen2 comments</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">document</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build vignettes</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">build_vignettes</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build pkgdown site</span></span>
<span><span class="fu">pkgdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">build_site</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>pkgdown Website Building:</strong></p>
<p>The package uses pkgdown to generate a website from package documentation. Configuration is in <code>_pkgdown.yml</code>.</p>
<p><strong>Workflow:</strong> 1. <strong>Update <code>_pkgdown.yml</code></strong> when adding new exported functions or classes - Add new classes to the “S7 Classes” section in <code>reference:</code> - Add new functions to appropriate sections - Example: After adding <code>SerialMediationData</code>, must add to reference index</p>
<ol start="2" style="list-style-type: decimal"><li>
<p><strong>Build and check site:</strong></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pkgdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">build_site</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Common issues:</strong></p>
<ul><li>
<strong>“Topic missing from index”</strong>: Add the topic to <code>_pkgdown.yml</code> reference section</li>
<li>
<strong>“URL not ok”</strong>: Ensure DESCRIPTION has correct URL field</li>
<li>
<strong>Non-ASCII characters</strong>: Replace with ASCII equivalents (-&gt; instead of →, * instead of ×)</li>
</ul></li>
</ol><p><strong>pkgdown Configuration Essentials:</strong> - Reference index must list ALL exported topics - Group related functions/classes together for better organization - Use <code>starts_with()</code> patterns for methods (print<em>, summary</em>, etc.) - Website builds to <code>docs/</code> directory</p>
<p><strong>MathJax and LaTeX Equations:</strong></p>
<p>Equation syntax differs by context. Use the correct format for each file type:</p>
<table class="table"><colgroup><col width="16%"><col width="24%"><col width="28%"><col width="30%"></colgroup><thead><tr class="header"><th>Context</th>
<th>File Format</th>
<th>Inline Syntax</th>
<th>Display Syntax</th>
</tr></thead><tbody><tr class="odd"><td><strong>Function Docs</strong></td>
<td>
<code>.Rd</code> / roxygen2</td>
<td><code>\eqn{latex}{ascii}</code></td>
<td><code>\deqn{latex}{ascii}</code></td>
</tr><tr class="even"><td><strong>Vignettes/Articles</strong></td>
<td>
<code>.qmd</code> (Quarto)</td>
<td><code>$equation$</code></td>
<td><code>$$equation$$</code></td>
</tr><tr class="odd"><td><strong>Vignettes/Articles</strong></td>
<td>
<code>.Rmd</code> (R Markdown)</td>
<td><code>$equation$</code></td>
<td><code>$$equation$$</code></td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="id_1-function-documentation-roxygen2--rd-files">1. Function Documentation (roxygen2 / .Rd files)<a class="anchor" aria-label="anchor" href="#id_1-function-documentation-roxygen2--rd-files"></a></h3>
<p>Use Rd macros for help pages (<code>?function</code>):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' The indirect effect is \eqn{a \times b}{a * b}</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Sampling distribution:</span></span>
<span><span class="co">#' \deqn{N(\hat{\theta}, \hat{\Sigma})}{N(theta-hat, Sigma-hat)}</span></span></code></pre></div>
<p><strong>Rules:</strong> - <code>\eqn{latex}{ascii}</code> - inline (two arguments: LaTeX + ASCII fallback) - <code>\deqn{latex}{ascii}</code> - display/block math - Single argument form: <code>\eqn{latex}</code> uses same text for both - <strong>No whitespace</strong> between command and arguments! - R 4.2+ supports MathJax/KaTeX rendering in HTML help pages</p>
</div>
<div class="section level3">
<h3 id="id_2-quarto-vignettesarticles-qmd-files">2. Quarto Vignettes/Articles (.qmd files)<a class="anchor" aria-label="anchor" href="#id_2-quarto-vignettesarticles-qmd-files"></a></h3>
<p>Use standard LaTeX with dollar signs:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>The indirect effect is $a \times b$ where $a$ is the X-&gt;M path.</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>The sampling distribution is:</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>$$\hat{\theta} \sim N(\theta, \Sigma)$$</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_3-pkgdown-configuration">3. pkgdown Configuration<a class="anchor" aria-label="anchor" href="#id_3-pkgdown-configuration"></a></h3>
<p>Enable MathJax in <code>_pkgdown.yml</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="at">  </span><span class="fu">bootstrap</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="at">  </span><span class="fu">math-rendering</span><span class="kw">:</span><span class="at"> mathjax</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_4-common-latex-symbols">4. Common LaTeX Symbols<a class="anchor" aria-label="anchor" href="#id_4-common-latex-symbols"></a></h3>
<table class="table"><colgroup><col width="38%"><col width="23%"><col width="38%"></colgroup><thead><tr class="header"><th>Category</th>
<th>Code</th>
<th>Rendered</th>
</tr></thead><tbody><tr class="odd"><td>Greek letters</td>
<td>
<code>\alpha</code>, <code>\beta</code>, <code>\theta</code>, <code>\Sigma</code>
</td>
<td>
<span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, <span class="math inline">\(\theta\)</span>, <span class="math inline">\(\Sigma\)</span>
</td>
</tr><tr class="even"><td>Hats/accents</td>
<td>
<code>\hat{x}</code>, <code>\bar{x}</code>, <code>\tilde{x}</code>
</td>
<td>
<span class="math inline">\(\hat{x}\)</span>, <span class="math inline">\(\bar{x}\)</span>, <span class="math inline">\(\tilde{x}\)</span>
</td>
</tr><tr class="odd"><td>Subscripts/superscripts</td>
<td>
<code>x_i</code>, <code>x^2</code>
</td>
<td>
<span class="math inline">\(x_i\)</span>, <span class="math inline">\(x^2\)</span>
</td>
</tr><tr class="even"><td>Fractions</td>
<td><code>\frac{a}{b}</code></td>
<td><span class="math inline">\(\frac{a}{b}\)</span></td>
</tr><tr class="odd"><td>Operators</td>
<td>
<code>\times</code>, <code>\cdot</code>, <code>\sum</code>, <code>\prod</code>
</td>
<td>
<span class="math inline">\(\times\)</span>, <span class="math inline">\(\cdot\)</span>, <span class="math inline">\(\sum\)</span>, <span class="math inline">\(\prod\)</span>
</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="id_5-avoid-unicode-math-characters">5. Avoid Unicode Math Characters<a class="anchor" aria-label="anchor" href="#id_5-avoid-unicode-math-characters"></a></h3>
<p>In <code>.Rd</code> files and roxygen2 comments: - <strong>DON’T use</strong>: <code>θ</code>, <code>Σ</code>, <code>θ̂</code> (causes LaTeX PDF errors) - <strong>DO use</strong>: <code>\eqn{\theta}</code>, <code>\eqn{\Sigma}</code>, <code>\eqn{\hat{\theta}}</code></p>
<p>In <code>.qmd</code> files, Unicode is acceptable but LaTeX is preferred for consistency.</p>
<p><strong>Quarto Vignettes and pkgdown Workflow:</strong></p>
<p>To ensure Quarto vignettes pass workflow checks and render correctly on GitHub:</p>
<ol style="list-style-type: decimal"><li>
<p><strong>Initial Setup:</strong></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initialize pkgdown with GitHub Pages support</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_pkgdown_github_pages</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This automatically:</p>
<ul><li>Creates <code>gh-pages</code> branch for hosting</li>
<li>Generates <code>.github/workflows/pkgdown.yaml</code>
</li>
<li>Updates DESCRIPTION and <code>_pkgdown.yml</code> with site URL</li>
</ul></li>
<li>
<p><strong>Declare Dependencies:</strong></p>
<ul><li><p>List all vignette dependencies in DESCRIPTION under <code>Suggests</code></p></li>
<li>
<p>For website-only dependencies, use <code>Config/Needs/website</code> field:</p>
<pre><code>Config/Needs/website: ggplot2, dplyr, tidyr</code></pre>
</li>
<li><p>This ensures CI installs them without cluttering package dependencies</p></li>
</ul></li>
<li>
<p><strong>Quarto Support:</strong></p>
<ul><li>pkgdown automatically detects and renders Quarto vignettes</li>
<li>Vignettes appear in the <code>articles/</code> section of the website</li>
<li>No special configuration needed for basic Quarto files</li>
</ul></li>
<li>
<p><strong>Quarto Code Chunk Format (PREFERRED):</strong></p>
<p>Use Quarto’s hash-pipe (<code>#|</code>) syntax for chunk options, NOT R Markdown inline syntax:</p>
<p><strong>CORRECT (Quarto format):</strong></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="in">#| label: my-chunk</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="in">#| eval: false</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="in">#| echo: true</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="in">x &lt;- 1 + 1</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="in">```</span></span></code></pre></div>
<p><strong>INCORRECT (R Markdown format):</strong></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="in">```{r my-chunk, eval=FALSE, echo=TRUE}</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="in">x &lt;- 1 + 1</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="in">```</span></span></code></pre></div>
<p><strong>Key differences:</strong></p>
<ul><li>Chunk label: <code>#| label: chunk-name</code> (not <code>{r chunk-name}</code>)</li>
<li>Options on separate lines with <code>#|</code> prefix</li>
<li>Boolean values: <code>true</code>/<code>false</code> (not <code>TRUE</code>/<code>FALSE</code>)</li>
<li>Use hyphens in labels: <code>my-chunk</code> (not <code>my_chunk</code>)</li>
</ul><p><strong>Common chunk options:</strong></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co">#| label: chunk-name</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="co">#| fig-height: 6</span></span></code></pre></div>
</li>
<li>
<p><strong>Computationally Expensive Vignettes:</strong></p>
<ul><li>
<p>If vignette code is slow or requires credentials, use <strong>Articles</strong> instead:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_article</span><span class="op">(</span><span class="st">"article-name"</span><span class="op">)</span></span></code></pre></div>
</li>
<li><p>Articles are rendered by pkgdown but NOT included in <code>R CMD check</code></p></li>
<li><p>Prevents timeouts and failures on CI servers</p></li>
<li><p>Use for: heavy simulations, API examples requiring keys, large data processing</p></li>
</ul></li>
<li>
<p><strong>Common Workflow Failures:</strong></p>
<ul><li>
<strong>Missing system libraries</strong>: Ensure system dependencies are available on CI runner</li>
<li>
<strong>Malformed markdown</strong>: Use consistent header levels (<code>#</code>, <code>##</code>) in NEWS.md</li>
<li>
<strong>Branch permissions</strong>: Workflow needs write access to <code>gh-pages</code> branch</li>
<li>
<strong>Missing dependencies</strong>: Check that all packages used in vignettes are in DESCRIPTION</li>
</ul></li>
<li>
<p><strong>Workflow Checklist:</strong></p>
<ul class="task-list"><li><label><input type="checkbox">Run <code>usethis::use_pkgdown_github_pages()</code> for initial setup</label></li>
<li><label><input type="checkbox">Add vignette dependencies to DESCRIPTION <code>Suggests</code> or <code>Config/Needs/website</code></label></li>
<li><label><input type="checkbox">Convert heavy vignettes to Articles with <code>usethis::use_article()</code></label></li>
<li><label><input type="checkbox">Test locally with <code><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">pkgdown::build_site()</a></code> before pushing</label></li>
<li><label><input type="checkbox">Verify GitHub Actions has permission to deploy to <code>gh-pages</code></label></li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a></h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run all tests</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">test</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run specific test file</span></span>
<span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_file.html" class="external-link">test_file</a></span><span class="op">(</span><span class="st">"tests/testthat/test-classes.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check coverage</span></span>
<span><span class="fu">covr</span><span class="fu">::</span><span class="fu">package_coverage</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="coding-standards">Coding Standards<a class="anchor" aria-label="anchor" href="#coding-standards"></a></h2>
<div class="section level3">
<h3 id="r-version-and-style">R Version and Style<a class="anchor" aria-label="anchor" href="#r-version-and-style"></a></h3>
<ul><li>
<strong>Minimum R version</strong>: 4.1.0 (native pipe <code>|&gt;</code> support)</li>
<li>
<strong>OOP Framework</strong>: S7 (modern object system)</li>
<li>
<strong>Style</strong>: tidyverse style guide with native pipe</li>
<li>
<strong>Roxygen2</strong>: Use roxygen2 for documentation (&gt;= 7.3.0)</li>
<li>
<strong>Clarity priority</strong>: Code must be readable and maintainable</li>
</ul></div>
<div class="section level3">
<h3 id="naming-conventions">Naming Conventions<a class="anchor" aria-label="anchor" href="#naming-conventions"></a></h3>
<p>The package uses <strong>snake_case</strong> consistently:</p>
<p><strong>Functions:</strong> - Main exports: <code><a href="reference/fit_mediation.html">fit_mediation()</a></code>, <code><a href="reference/extract_mediation.html">extract_mediation()</a></code>, <code><a href="reference/bootstrap_mediation.html">bootstrap_mediation()</a></code> - Internal functions prefix with dot: <code>.fit_mediation_glm()</code>, <code>.bootstrap_parametric()</code></p>
<p><strong>Arguments:</strong> - <code>formula_y</code>, <code>formula_m</code> for model specifications - <code>treatment</code>, <code>mediator</code>, <code>outcome</code> for variable names - <code>engine</code> for modeling engine: “glm”, “lmer”, “brms” - <code>method</code> for inference method: “parametric”, “nonparametric”, “plugin” - <code>n_boot</code> for number of bootstrap samples - <code>ci_level</code> for confidence level (default: 0.95)</p>
<p><strong>S7 Classes:</strong> - CamelCase: <code>MediationData</code>, <code>BootstrapResult</code> - Properties use snake_case: <code>@a_path</code>, <code>@boot_estimates</code></p>
</div>
<div class="section level3">
<h3 id="code-documentation-style">Code Documentation Style<a class="anchor" aria-label="anchor" href="#code-documentation-style"></a></h3>
<p><strong>General Principles:</strong> - <strong>Comment the “why”, not the “what”</strong> - explain reasoning, not obvious operations - <strong>More explanatory comments for tricky code</strong> - shortcuts, clever tricks, non-obvious logic deserve explanation - <strong>Inline citations for statistical methods</strong> - e.g., <code># Per VanderWeele (2014), four-way decomposition...</code> - <strong>Self-documenting code first</strong> - use clear variable names, then add comments for context</p>
<p><strong>In-line Comment Examples:</strong></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># BAD - explains what (obvious)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span>  <span class="co"># add 1 to x</span></span>
<span></span>
<span><span class="co"># GOOD - explains why</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span>  <span class="co"># Adjust for 1-based indexing expected by lavaan</span></span>
<span></span>
<span><span class="co"># GOOD - explains tricky shortcut</span></span>
<span><span class="co"># Use outer product for efficient pairwise computation (O(n²) memory but O(1) loops)</span></span>
<span><span class="va">pairwise_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span>, <span class="va">`-`</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># GOOD - inline citation</span></span>
<span><span class="co"># Per VanderWeele (2014), the four-way decomposition requires: TE = CDE + INTref + INTmed + PIE</span></span></code></pre></div>
<p><strong>Section Headers in Functions:</strong> Use <code># --- Section Name ---</code> for functions longer than ~30 lines:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># --- Validate Inputs ---</span></span>
<span>  <span class="va">...</span></span>
<span></span>
<span>  <span class="co"># --- Extract Parameters ---</span></span>
<span>  <span class="va">...</span></span>
<span></span>
<span>  <span class="co"># --- Compute Results ---</span></span>
<span>  <span class="va">...</span></span>
<span></span>
<span>  <span class="co"># --- Return ---</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>roxygen2 Documentation:</strong> Prefer BOTH concise <code>@description</code> AND detailed <code>@details</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Extract Mediation Structure from Fitted Models</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @description</span></span>
<span><span class="co">#' Generic function to extract mediation paths (a, b, c') and</span></span>
<span><span class="co">#' variance-covariance matrices from fitted models.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param object Fitted model object (lm, glm, lavaan)</span></span>
<span><span class="co">#' @param treatment Character: treatment variable name</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return A [MediationData] object</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @details</span></span>
<span><span class="co">#' ## Supported Model Types</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' - **lm/glm**: Requires separate mediator and outcome models</span></span>
<span><span class="co">#' - **lavaan**: Extracts from SEM; auto-detects paths if labeled</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' ## Mathematical Background</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' The indirect effect is \eqn{a \times b}{a * b} where:</span></span>
<span><span class="co">#' - \eqn{a} = effect of X on M (from mediator model)</span></span>
<span><span class="co">#' - \eqn{b} = effect of M on Y controlling for X (from outcome model)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Per Baron &amp; Kenny (1986), mediation requires significant a and b paths.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @references</span></span>
<span><span class="co">#' Baron RM, Kenny DA (1986). The moderator-mediator variable distinction.</span></span>
<span><span class="co">#' *Journal of Personality and Social Psychology*, 51(6), 1173-1182.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' \dontrun{</span></span>
<span><span class="co">#' fit_m &lt;- lm(M ~ X + C, data = mydata)</span></span>
<span><span class="co">#' fit_y &lt;- lm(Y ~ X + M + C, data = mydata)</span></span>
<span><span class="co">#' med_data &lt;- extract_mediation(fit_m, model_y = fit_y,</span></span>
<span><span class="co">#'                               treatment = "X", mediator = "M")</span></span>
<span><span class="co">#' }</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @seealso [MediationData], [fit_mediation()]</span></span>
<span><span class="co">#' @export</span></span></code></pre></div>
<p><strong>TODO/FIXME Conventions:</strong></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># TODO: Add support for multiple mediators (issue #42)</span></span>
<span><span class="co"># FIXME: Breaks when n &lt; 10, needs better error handling</span></span>
<span><span class="co"># HACK: Workaround for lavaan bug, remove when fixed upstream</span></span>
<span><span class="co"># NOTE: Assumes Gaussian residuals for variance computation</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="code-organization">Code Organization<a class="anchor" aria-label="anchor" href="#code-organization"></a></h3>
<pre><code>R/
├── aaa-imports.R           # Package imports and setup
├── aab-generics.R          # S7 generic functions (must load before methods)
├── medfit-package.R        # Package documentation
├── classes.R               # S7 class definitions
├── fit-glm.R              # GLM engine implementation
├── extract-lm.R           # lm/glm extraction
├── extract-lavaan.R       # lavaan extraction
├── bootstrap.R            # Bootstrap infrastructure
├── utils.R                # Utility functions
└── zzz.R                  # .onLoad() for dynamic dispatch</code></pre>
<hr></div>
</div>
<div class="section level2">
<h2 id="defensive-programming">Defensive Programming<a class="anchor" aria-label="anchor" href="#defensive-programming"></a></h2>
<p>Defensive programming employs a multi-layered approach: strict input validation, formal object definitions, automated testing, and continuous integration.</p>
<div class="section level3">
<h3 id="id_1-input-validation-with-checkmate">1. Input Validation with checkmate<a class="anchor" aria-label="anchor" href="#id_1-input-validation-with-checkmate"></a></h3>
<p><strong>ALWAYS use checkmate</strong> for function argument validation. It provides fast (C-based), memory-efficient assertions with informative error messages.</p>
<p><strong>Required import</strong> in <code>R/aaa-imports.R</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @import checkmate</span></span></code></pre></div>
<p><strong>Common assertion patterns:</strong></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">n</span>, <span class="va">method</span>, <span class="va">data</span>, <span class="va">optional_arg</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># --- Input Validation (using checkmate for fail-fast defensive programming) ---</span></span>
<span></span>
<span>  <span class="co"># Type assertions</span></span>
<span>  <span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/checkNumeric.html" class="external-link">assert_numeric</a></span><span class="op">(</span><span class="va">x</span>, .var.name <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span></span>
<span>  <span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/checkCount.html" class="external-link">assert_count</a></span><span class="op">(</span><span class="va">n</span>, positive <span class="op">=</span> <span class="cn">TRUE</span>, .var.name <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span>  <span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/checkString.html" class="external-link">assert_string</a></span><span class="op">(</span><span class="va">method</span>, .var.name <span class="op">=</span> <span class="st">"method"</span><span class="op">)</span></span>
<span>  <span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/checkDataFrame.html" class="external-link">assert_data_frame</a></span><span class="op">(</span><span class="va">data</span>, .var.name <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Optional arguments (allow NULL)</span></span>
<span>  <span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/checkString.html" class="external-link">assert_string</a></span><span class="op">(</span><span class="va">optional_arg</span>, null.ok <span class="op">=</span> <span class="cn">TRUE</span>, .var.name <span class="op">=</span> <span class="st">"optional_arg"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Choice from options</span></span>
<span>  <span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/checkChoice.html" class="external-link">assert_choice</a></span><span class="op">(</span><span class="va">method</span>, choices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"parametric"</span>, <span class="st">"nonparametric"</span>, <span class="st">"plugin"</span><span class="op">)</span>,</span>
<span>                           .var.name <span class="op">=</span> <span class="st">"method"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Class checks (multiple allowed classes)</span></span>
<span>  <span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/checkMultiClass.html" class="external-link">assert_multi_class</a></span><span class="op">(</span><span class="va">model</span>, classes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lm"</span>, <span class="st">"glm"</span><span class="op">)</span>, .var.name <span class="op">=</span> <span class="st">"model"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Logical flags</span></span>
<span></span>
<span>  <span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/checkFlag.html" class="external-link">assert_flag</a></span><span class="op">(</span><span class="va">verbose</span>, .var.name <span class="op">=</span> <span class="st">"verbose"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Variable exists in data</span></span>
<span>  <span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/checkChoice.html" class="external-link">assert_choice</a></span><span class="op">(</span><span class="va">treatment</span>, choices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>                           .var.name <span class="op">=</span> <span class="st">"treatment in data"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ... rest of function</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Key checkmate functions:</strong></p>
<table class="table"><colgroup><col width="35%"><col width="32%"><col width="32%"></colgroup><thead><tr class="header"><th>Function</th>
<th>Purpose</th>
<th>Example</th>
</tr></thead><tbody><tr class="odd"><td><code>assert_string()</code></td>
<td>Single character string</td>
<td><code>assert_string(x)</code></td>
</tr><tr class="even"><td><code>assert_character()</code></td>
<td>Character vector</td>
<td><code>assert_character(x, min.len = 1)</code></td>
</tr><tr class="odd"><td><code>assert_numeric()</code></td>
<td>Numeric vector</td>
<td><code>assert_numeric(x, lower = 0)</code></td>
</tr><tr class="even"><td><code>assert_count()</code></td>
<td>Single positive integer</td>
<td><code>assert_count(n, positive = TRUE)</code></td>
</tr><tr class="odd"><td><code>assert_int()</code></td>
<td>Single integer</td>
<td><code>assert_int(n, lower = 1)</code></td>
</tr><tr class="even"><td><code>assert_flag()</code></td>
<td>Single logical</td>
<td><code>assert_flag(verbose)</code></td>
</tr><tr class="odd"><td><code>assert_choice()</code></td>
<td>Value from set</td>
<td><code>assert_choice(x, c("a", "b"))</code></td>
</tr><tr class="even"><td><code>assert_subset()</code></td>
<td>Subset of set</td>
<td><code>assert_subset(x, c("a", "b", "c"))</code></td>
</tr><tr class="odd"><td><code>assert_data_frame()</code></td>
<td>Data frame</td>
<td><code>assert_data_frame(df, min.rows = 1)</code></td>
</tr><tr class="even"><td><code>assert_matrix()</code></td>
<td>Matrix</td>
<td><code>assert_matrix(m, nrows = 3)</code></td>
</tr><tr class="odd"><td><code>assert_list()</code></td>
<td>List</td>
<td><code>assert_list(x, types = "numeric")</code></td>
</tr><tr class="even"><td><code>assert_class()</code></td>
<td>Single class</td>
<td><code>assert_class(obj, "lm")</code></td>
</tr><tr class="odd"><td><code>assert_multi_class()</code></td>
<td>Any of classes</td>
<td><code>assert_multi_class(obj, c("lm", "glm"))</code></td>
</tr><tr class="even"><td><code>assert_function()</code></td>
<td>Function</td>
<td><code>assert_function(f, nargs = 2)</code></td>
</tr></tbody></table><p><strong>Options for all assertions:</strong> - <code>.var.name = "name"</code>: Custom variable name in error message - <code>null.ok = TRUE</code>: Allow NULL values - <code>add = collection</code>: Add to assertion collection for batch checking</p>
<p><strong>Quick assertions with qassert:</strong></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compact type checking</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/qassert.html" class="external-link">qassert</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"N1"</span><span class="op">)</span>   <span class="co"># Numeric, length 1</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/qassert.html" class="external-link">qassert</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"S1"</span><span class="op">)</span>   <span class="co"># String, length 1</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/qassert.html" class="external-link">qassert</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"B1"</span><span class="op">)</span>   <span class="co"># Boolean/logical, length 1</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/qassert.html" class="external-link">qassert</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"X"</span><span class="op">)</span>    <span class="co"># NULL</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/qassert.html" class="external-link">qassert</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"N+"</span><span class="op">)</span>   <span class="co"># Numeric, length &gt;= 1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_2-handling-ellipsis-">2. Handling Ellipsis (<code>...</code>)<a class="anchor" aria-label="anchor" href="#id_2-handling-ellipsis-"></a></h3>
<p>When using <code>...</code> in function arguments, validate that passed arguments are actually used:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Check that all ... arguments are used</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/check_dots_used.html" class="external-link">check_dots_used</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Or for stricter checking (error on unused dots)</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/check_dots_empty.html" class="external-link">check_dots_empty</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ... rest of function</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Why this matters</strong>: Without checking, misspelled arguments are silently ignored:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># User typo: "treamtent" instead of "treatment"</span></span>
<span><span class="fu"><a href="reference/extract_mediation.html">extract_mediation</a></span><span class="op">(</span><span class="va">fit</span>, treamtent <span class="op">=</span> <span class="st">"X"</span><span class="op">)</span>  <span class="co"># Silently ignored without check!</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_3-s7-class-validation-already-in-use">3. S7 Class Validation (Already in Use)<a class="anchor" aria-label="anchor" href="#id_3-s7-class-validation-already-in-use"></a></h3>
<p>S7 provides automatic type validation through property declarations and custom validators:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MyClass</span> <span class="op">&lt;-</span> <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_class</a></span><span class="op">(</span></span>
<span>  <span class="st">"MyClass"</span>,</span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co"># Automatic type checking</span></span>
<span>    x <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,</span>
<span>    name <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_character</a></span></span>
<span>  <span class="op">)</span>,</span>
<span>  validator <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Custom validation for cross-property constraints</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">x</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="st">"x must be scalar"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">x</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="st">"x must be non-negative"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="cn">NULL</span>  <span class="co"># Return NULL if valid</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>S7 + checkmate complement each other:</strong> - S7 validators: Class-level constraints, cross-property validation - checkmate: Function argument validation (fail-fast at entry point)</p>
</div>
<div class="section level3">
<h3 id="id_4-testing-strategy">4. Testing Strategy<a class="anchor" aria-label="anchor" href="#id_4-testing-strategy"></a></h3>
<p><strong>Four-layer testing approach:</strong></p>
<ol style="list-style-type: decimal"><li>
<p><strong>Unit Testing</strong> (testthat)</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"function handles edge cases"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_error</span><span class="op">(</span><span class="fu">my_func</span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span>, <span class="st">"must not be NULL"</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu">my_func</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, <span class="va">expected_value</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li><p><strong>Acceptance Testing</strong>: Validate user workflows end-to-end</p></li>
<li>
<p><strong>Code Coverage</strong> (covr)</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Target: &gt;80% coverage, 100% for critical paths</span></span>
<span><span class="fu">covr</span><span class="fu">::</span><span class="fu">package_coverage</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Snapshot Testing</strong>: For complex outputs</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"print output is stable"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_snapshot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">my_object</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
</ol></div>
<div class="section level3">
<h3 id="id_5-dependency-management">5. Dependency Management<a class="anchor" aria-label="anchor" href="#id_5-dependency-management"></a></h3>
<p><strong>CRITICAL rules:</strong></p>
<ol style="list-style-type: decimal"><li>
<p><strong>Never use <code><a href="https://rdrr.io/r/base/library.html" class="external-link">library()</a></code> or <code><a href="https://rdrr.io/r/base/library.html" class="external-link">require()</a></code> inside package functions</strong></p>
<ul><li>These alter the global search path</li>
<li>Use explicit namespacing: <code>package::function()</code>
</li>
</ul></li>
<li>
<p><strong>Imports vs Suggests:</strong></p>
<ul><li>
<strong>Imports</strong>: Required packages (always available)</li>
<li>
<strong>Suggests</strong>: Optional packages (check availability)</li>
</ul><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For Suggested packages, check availability</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"lavaan"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Package 'lavaan' is required but not installed."</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">lavaan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lavaan/man/sem.html" class="external-link">sem</a></span><span class="op">(</span><span class="va">model</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Version pinning</strong> in DESCRIPTION:</p>
<pre><code>Imports:
    S7 (&gt;= 0.1.0),
    checkmate
Suggests:
    lavaan (&gt;= 0.6-0)</code></pre>
</li>
</ol></div>
<div class="section level3">
<h3 id="id_6-managing-state-and-side-effects">6. Managing State and Side Effects<a class="anchor" aria-label="anchor" href="#id_6-managing-state-and-side-effects"></a></h3>
<p><strong>Clean up side effects with <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>:</strong></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Save current state</span></span>
<span>  <span class="va">old_opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>warn <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">old_wd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Ensure cleanup even if function errors</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">old_opts</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">old_wd</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ... function body</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>File system hygiene:</strong> - Never write to user’s home directory - Use <code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir()</a></code> for temporary files - Use <code>tools::R_user_dir("medfit", "cache")</code> for persistent cache</p>
<p><strong>Prefer pure functions:</strong> - Return values instead of modifying in place - Avoid global state modifications</p>
</div>
<div class="section level3">
<h3 id="id_7-continuous-integration-ci">7. Continuous Integration (CI)<a class="anchor" aria-label="anchor" href="#id_7-continuous-integration-ci"></a></h3>
<p><strong>GitHub Actions workflow</strong> (<code>.github/workflows/R-CMD-check.yaml</code>):</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">,</span><span class="at"> dev</span><span class="kw">]</span></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a><span class="at">  </span><span class="fu">pull_request</span><span class="kw">:</span></span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">]</span></span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> R-CMD-check</span></span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a><span class="at">  </span><span class="fu">R-CMD-check</span><span class="kw">:</span></span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ${{ matrix.os }}</span></span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a><span class="at">    </span><span class="fu">strategy</span><span class="kw">:</span></span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a><span class="at">      </span><span class="fu">matrix</span><span class="kw">:</span></span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a><span class="at">        </span><span class="fu">os</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">ubuntu-latest</span><span class="kw">,</span><span class="at"> macos-latest</span><span class="kw">,</span><span class="at"> windows-latest</span><span class="kw">]</span></span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a><span class="at">        </span><span class="fu">r-version</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">'release'</span><span class="kw">]</span></span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb31-18"><a href="#cb31-18" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb31-19"><a href="#cb31-19" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> r-lib/actions/setup-r@v2</span></span>
<span id="cb31-21"><a href="#cb31-21" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb31-22"><a href="#cb31-22" tabindex="-1"></a><span class="at">          </span><span class="fu">r-version</span><span class="kw">:</span><span class="at"> ${{ matrix.r-version }}</span></span>
<span id="cb31-23"><a href="#cb31-23" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> r-lib/actions/setup-r-dependencies@v2</span></span>
<span id="cb31-25"><a href="#cb31-25" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb31-26"><a href="#cb31-26" tabindex="-1"></a><span class="at">          </span><span class="fu">extra-packages</span><span class="kw">:</span><span class="at"> any::rcmdcheck</span></span>
<span id="cb31-27"><a href="#cb31-27" tabindex="-1"></a></span>
<span id="cb31-28"><a href="#cb31-28" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> r-lib/actions/check-r-package@v2</span></span></code></pre></div>
<p><strong>Static code analysis</strong> with lintr:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># .lintr file in package root</span></span>
<span><span class="va">linters</span><span class="op">:</span> <span class="fu">linters_with_defaults</span><span class="op">(</span></span>
<span>  <span class="fu">line_length_linter</span><span class="op">(</span><span class="fl">120</span><span class="op">)</span>,</span>
<span>  <span class="fu">object_name_linter</span><span class="op">(</span>styles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"snake_case"</span>, <span class="st">"CamelCase"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_8-defensive-programming-checklist">8. Defensive Programming Checklist<a class="anchor" aria-label="anchor" href="#id_8-defensive-programming-checklist"></a></h3>
<p>For every new function:</p>
<ul class="task-list"><li><label><input type="checkbox">Add checkmate assertions for all arguments at function entry</label></li>
<li><label><input type="checkbox">Use <code>.var.name</code> parameter for clear error messages</label></li>
<li><label><input type="checkbox">Allow NULL where appropriate with <code>null.ok = TRUE</code></label></li>
<li><label><input type="checkbox">Check <code>...</code> arguments with <code><a href="https://rlang.r-lib.org/reference/check_dots_used.html" class="external-link">rlang::check_dots_used()</a></code> if applicable</label></li>
<li><label><input type="checkbox">Use explicit namespacing for all non-base functions</label></li>
<li><label><input type="checkbox">Clean up side effects with <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code></label></li>
<li><label><input type="checkbox">Write tests for error conditions</label></li>
<li><label><input type="checkbox">Verify function works with edge cases (NULL, empty, NA)</label></li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="code-architecture">Code Architecture<a class="anchor" aria-label="anchor" href="#code-architecture"></a></h2>
<div class="section level3">
<h3 id="s7-object-system">S7 Object System<a class="anchor" aria-label="anchor" href="#s7-object-system"></a></h3>
<p>The package uses S7 for type-safe, modern object-oriented programming.</p>
<p><strong>Key S7 Classes:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong><code>MediationData</code></strong> - Simple mediation (X -&gt; M -&gt; Y)
<ul><li>Properties: <code>a_path</code>, <code>b_path</code>, <code>c_prime</code>, <code>estimates</code>, <code>vcov</code>, <code>data</code>, etc.</li>
<li>Validator ensures internal consistency</li>
<li>For product-of-two indirect effects (a * b)</li>
</ul></li>
<li>
<strong><code>SerialMediationData</code></strong> - Serial mediation (X -&gt; M1 -&gt; M2 -&gt; … -&gt; Y)
<ul><li>Properties: <code>a_path</code>, <code>d_path</code> (vector), <code>b_path</code>, <code>c_prime</code>, <code>mediators</code> (vector), etc.</li>
<li>Supports product-of-three (a * d * b) and product-of-k</li>
<li>Flexible <code>d_path</code>: scalar for 2 mediators, vector for 3+</li>
<li>Extensible to chains of any length</li>
</ul></li>
<li>
<strong><code>BootstrapResult</code></strong> - Bootstrap inference results
<ul><li>Properties: <code>estimate</code>, <code>ci_lower</code>, <code>ci_upper</code>, <code>boot_estimates</code>, <code>method</code>
</li>
<li>Validator checks consistency</li>
<li>Used by all packages for inference</li>
</ul></li>
</ol><p><strong>S7 Generics:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong><code><a href="reference/extract_mediation.html">extract_mediation()</a></code></strong> - Extract mediation structure from models
<ul><li>Methods: <code>lm</code>, <code>glm</code>, <code>lavaan</code>, (future: <code>lmerMod</code>, <code>brmsfit</code>)</li>
<li>Returns: <code>MediationData</code> object</li>
</ul></li>
<li>
<strong><code><a href="reference/fit_mediation.html">fit_mediation()</a></code></strong> - Fit mediation models
<ul><li>Dispatcher to engine-specific functions</li>
<li>Returns: <code>MediationData</code> object</li>
</ul></li>
<li>
<strong><code><a href="reference/bootstrap_mediation.html">bootstrap_mediation()</a></code></strong> - Perform bootstrap inference
<ul><li>Methods: parametric, nonparametric, plugin</li>
<li>Returns: <code>BootstrapResult</code> object</li>
</ul></li>
</ol><p><strong>S7 Documentation Patterns:</strong></p>
<p>When documenting S7 classes and methods with roxygen2:</p>
<ol style="list-style-type: decimal"><li>
<p><strong>S7 Class Constructors</strong>: Use explicit <code>@param</code> tags for all properties</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' MediationData S7 Class</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @description</span></span>
<span><span class="co">#' S7 class containing standardized mediation model structure</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param a_path Numeric scalar: effect of treatment on mediator</span></span>
<span><span class="co">#' @param b_path Numeric scalar: effect of mediator on outcome</span></span>
<span><span class="co">#' # ... document ALL properties explicitly</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return A MediationData S7 object</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">MediationData</span> <span class="op">&lt;-</span> <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_class</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>S7 Methods</strong>: Use <code>@noRd</code> to prevent namespace export issues</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Print Method for MediationData</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x A MediationData object</span></span>
<span><span class="co">#' @param ... Additional arguments (ignored)</span></span>
<span><span class="co">#' @noRd</span></span>
<span><span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/method.html" class="external-link">method</a></span><span class="op">(</span><span class="va">print</span>, <span class="va">MediationData</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> <span class="va">...</span> <span class="op">}</span></span></code></pre></div>
<p><strong>Important</strong>:</p>
<ul><li>Do NOT use <code>@export</code> for S7 methods (causes namespace errors)</li>
<li>Do NOT use <code>@name</code> tag (causes duplicate .Rd files)</li>
<li>Use <code>@noRd</code> to document internally without generating .Rd files</li>
<li>S7 methods work via automatic dispatch, not namespace exports</li>
</ul></li>
<li>
<p><strong>S7 Generics</strong>: Only document generic parameters, not method-specific ones</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Extract Mediation Structure</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param object Fitted model object</span></span>
<span><span class="co">#' @param ... Additional arguments passed to methods. Common arguments include:</span></span>
<span><span class="co">#'   - `treatment`: Character string (document in prose, not as @param)</span></span>
<span><span class="co">#'   - `mediator`: Character string (document in prose, not as @param)</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">extract_mediation</span> <span class="op">&lt;-</span> <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_generic.html" class="external-link">new_generic</a></span><span class="op">(</span><span class="st">"extract_mediation"</span>, dispatch_args <span class="op">=</span> <span class="st">"object"</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Testing S7 Methods</strong>: Method dispatch may not work in installed package context</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"MediationData print method works"</span>, <span class="op">{</span></span>
<span>  <span class="fu">skip_if_not</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"S7 method dispatch issue in non-interactive mode"</span><span class="op">)</span></span>
<span>  <span class="co"># ... test code</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>S7 Method Registration in .onLoad()</strong>: REQUIRED per official S7 documentation</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CORRECT - per https://rconsortium.github.io/S7/articles/packages.html</span></span>
<span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># 1. First register S7 classes with S4 system</span></span>
<span>  <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/S4_register.html" class="external-link">S4_register</a></span><span class="op">(</span><span class="va">MediationData</span><span class="op">)</span></span>
<span>  <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/S4_register.html" class="external-link">S4_register</a></span><span class="op">(</span><span class="va">SerialMediationData</span><span class="op">)</span></span>
<span>  <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/S4_register.html" class="external-link">S4_register</a></span><span class="op">(</span><span class="va">BootstrapResult</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 2. Then register S7 methods for dispatch</span></span>
<span>  <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/methods_register.html" class="external-link">methods_register</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 3. Register methods for Suggested packages (if available)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"lavaan"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="fu"><a href="reference/dot-register_lavaan_method.html">.register_lavaan_method</a></span><span class="op">(</span><span class="op">)</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Key points</strong>:</p>
<ul><li>
<code>S4_register()</code> MUST be called for each S7 class BEFORE <code>methods_register()</code>
</li>
<li>
<code>methods_register()</code> MUST be in <code>.onLoad()</code>, NOT <code>.onAttach()</code>
</li>
<li>Import full <code>methods</code> package: <code>@import methods</code> (not just <code>@importFrom methods is</code>)</li>
<li>The “Overwriting method” message during <code>devtools::load_all()</code> is a known development-time issue (GitHub #474) - does NOT affect installed packages</li>
<li>See: <a href="https://rconsortium.github.io/S7/articles/packages.html" class="external-link uri">https://rconsortium.github.io/S7/articles/packages.html</a>
</li>
<li>See: <a href="https://github.com/RConsortium/S7/issues/474" class="external-link uri">https://github.com/RConsortium/S7/issues/474</a>
</li>
</ul></li>
</ol><p><strong>S7 and S3 Class Integration:</strong></p>
<p>When working with S3 classes in S7 packages, follow this guide:</p>
<ol style="list-style-type: decimal"><li>
<p><strong>Mandatory Package Setup</strong>: Call <code><a href="https://rconsortium.github.io/S7/reference/methods_register.html" class="external-link">S7::methods_register()</a></code> in <code>.onLoad()</code></p>
<ul><li>Required for dynamic method registration</li>
<li>Especially important for methods on generics from other packages</li>
<li>Must call <code>S4_register()</code> for each class BEFORE <code>methods_register()</code>
</li>
</ul></li>
<li>
<p><strong>Formalizing S3 Classes</strong>: Use <code>new_S3_class()</code> to wrap S3 classes</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Register method for S3 class</span></span>
<span><span class="fu">method</span><span class="op">(</span><span class="va">my_generic</span>, <span class="fu">new_S3_class</span><span class="op">(</span><span class="st">"data.frame"</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">...</span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Use in property definitions</span></span>
<span><span class="va">MyClass</span> <span class="op">&lt;-</span> <span class="fu">new_class</span><span class="op">(</span><span class="st">"MyClass"</span>,</span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu">new_S3_class</span><span class="op">(</span><span class="st">"data.frame"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use in unions</span></span>
<span><span class="va">my_union</span> <span class="op">&lt;-</span> <span class="fu">new_union</span><span class="op">(</span><span class="va">class_numeric</span>, <span class="fu">new_S3_class</span><span class="op">(</span><span class="st">"Date"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Built-in S3 wrappers</strong>: S7 provides <code>class_data.frame</code>, <code>class_Date</code>, <code>class_factor</code>, etc.</p>
</li>
<li>
<p><strong>Inheriting from S3 Classes</strong>: Requires custom constructor</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># When inheriting from S3 via parent argument</span></span>
<span><span class="va">MyS7Class</span> <span class="op">&lt;-</span> <span class="fu">new_class</span><span class="op">(</span><span class="st">"MyS7Class"</span>,</span>
<span>  parent <span class="op">=</span> <span class="fu">new_S3_class</span><span class="op">(</span><span class="st">"integer"</span>,</span>
<span>    constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">.data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># .data must be first argument</span></span>
<span>      <span class="co"># Add S3 class attributes</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Calling Parent S3 Methods</strong>: Use <code>S7_data()</code>, not <code>super()</code></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># INCORRECT - S3 generics don't understand super()</span></span>
<span><span class="fu">method</span><span class="op">(</span><span class="va">print</span>, <span class="va">MyClass</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">super</span><span class="op">(</span><span class="va">x</span>, <span class="va">print</span><span class="op">)</span>  <span class="co"># FAILS</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># CORRECT - Extract underlying S3 object</span></span>
<span><span class="fu">method</span><span class="op">(</span><span class="va">print</span>, <span class="va">MyClass</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">S7_data</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Dispatches to S3 print method</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
<li>
<p><strong>Migrating S3 Packages to S7</strong>: Incremental approach</p>
<ul><li>Add <code><a href="https://rconsortium.github.io/S7/reference/methods_register.html" class="external-link">S7::methods_register()</a></code> to <code>.onLoad()</code>
</li>
<li>Wrap existing S3 classes with <code>new_S3_class()</code>
</li>
<li>Gradually replace informal S3 with formal <code>new_class()</code> definitions</li>
<li>Existing S3 code continues to work because S7 objects retain S3 class attribute</li>
</ul></li>
</ol><p><strong>S7 and S4 Class Integration:</strong></p>
<p>While S7 and S3 are fully compatible, S7 and S4 have specific interoperability features and limitations:</p>
<ol style="list-style-type: decimal"><li>
<p><strong>Registration with <code>S4_register()</code></strong>: CRITICAL for S4 compatibility</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define S7 class</span></span>
<span><span class="va">Foo</span> <span class="op">&lt;-</span> <span class="fu">new_class</span><span class="op">(</span><span class="st">"Foo"</span>, package <span class="op">=</span> <span class="st">"mypackage"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># REQUIRED: Register with S4 system</span></span>
<span><span class="fu">S4_register</span><span class="op">(</span><span class="va">Foo</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now can use with S4 generics</span></span>
<span><span class="fu">method</span><span class="op">(</span><span class="va">S4_generic</span>, <span class="va">Foo</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="st">"Hello"</span></span></code></pre></div>
<p><strong>Why required</strong>:</p>
<ul><li>S7 classes are created at runtime, not visible to S4 by default</li>
<li>Without registration, S4 dispatch won’t recognize the class</li>
<li>
<strong>In medfit</strong>: We call <code><a href="https://rconsortium.github.io/S7/reference/S4_register.html" class="external-link">S7::S4_register()</a></code> immediately after each class definition</li>
</ul></li>
<li>
<p><strong>Bidirectional Method Dispatch</strong>: S7 supports multiple combinations</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># S7 method on S4 generic (requires S4_register)</span></span>
<span><span class="fu">method</span><span class="op">(</span><span class="va">S4_generic</span>, <span class="va">S7_class</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">...</span><span class="op">}</span></span>
<span></span>
<span><span class="co"># S4 class on S7 generic</span></span>
<span><span class="fu">method</span><span class="op">(</span><span class="va">S7_generic</span>, <span class="va">S4_class</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">...</span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Mixed signatures work</span></span>
<span><span class="fu">method</span><span class="op">(</span><span class="va">my_generic</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">S7_class</span>, <span class="va">S4_class</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span><span class="va">...</span><span class="op">}</span></span></code></pre></div>
</li>
<li>
<p><strong>Inheritance Limitations - The “Firewall”</strong>:</p>
<p><strong>CRITICAL RESTRICTION</strong>: S7 cannot extend S4 classes</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># INVALID - Will fail</span></span>
<span><span class="va">MyClass</span> <span class="op">&lt;-</span> <span class="fu">new_class</span><span class="op">(</span><span class="st">"MyClass"</span>, parent <span class="op">=</span> <span class="va">SomeS4Class</span><span class="op">)</span></span></code></pre></div>
<p><strong>Why this matters</strong>:</p>
<ul><li>S7 cannot inherit from S4 (opposite direction may work)</li>
<li>Major barrier for Bioconductor ecosystem (S4-based)</li>
<li>Cannot subclass core S4 structures like <code>SummarizedExperiment</code>
</li>
<li>Must use composition instead of inheritance</li>
</ul><p><strong>Workaround</strong>: Use composition</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Instead of inheriting, wrap</span></span>
<span><span class="va">MyClass</span> <span class="op">&lt;-</span> <span class="fu">new_class</span><span class="op">(</span><span class="st">"MyClass"</span>,</span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    s4_object <span class="op">=</span> <span class="va">S4_class</span>  <span class="co"># Contain, don't extend</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Properties and Slots</strong>: Equivalent concepts</p>
<ul><li>S7 properties ≈ S4 slots (with added dynamics)</li>
<li>Can use S4 class as property type</li>
<li>S4 class unions auto-convert to <code>new_union()</code>
</li>
<li>Union handling differs: S4 at dispatch time, S7 at registration time</li>
</ul></li>
<li>
<p><strong>Migration Strategy - Bottom-Up Approach</strong>:</p>
<p>Because S7 cannot inherit from S4, migration requires careful planning:</p>
<p><strong>Step-by-step process</strong>:</p>
<ol style="list-style-type: decimal"><li>Identify S4 classes at bottom of hierarchy (no children)</li>
<li>Re-implement using <code>new_class()</code>
</li>
<li>Convert S4 slots → S7 properties</li>
<li>Convert S4 validity methods → S7 validator functions</li>
<li>Call <code>S4_register()</code> for backward compatibility</li>
<li>Move up hierarchy, replacing parents only after children converted</li>
</ol><p><strong>Example</strong>:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Old S4 class</span></span>
<span><span class="kw">setClass</span><span class="op">(</span><span class="st">"Foo"</span>, slots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"numeric"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">setValidity</span><span class="op">(</span><span class="st">"Foo"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">object</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">object</span><span class="op">@</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="st">"x must have length &gt; 0"</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># New S7 equivalent</span></span>
<span><span class="va">Foo</span> <span class="op">&lt;-</span> <span class="fu">new_class</span><span class="op">(</span><span class="st">"Foo"</span>,</span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">class_numeric</span></span>
<span>  <span class="op">)</span>,</span>
<span>  validator <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="st">"x must have length &gt; 0"</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">S4_register</span><span class="op">(</span><span class="va">Foo</span><span class="op">)</span>  <span class="co"># Maintain S4 compatibility</span></span></code></pre></div>
</li>
</ol></div>
<div class="section level3">
<h3 id="core-function-hierarchy">Core Function Hierarchy<a class="anchor" aria-label="anchor" href="#core-function-hierarchy"></a></h3>
<p><strong>User-Facing Functions:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong><code><a href="reference/fit_mediation.html">fit_mediation()</a></code></strong> - Fit models with formula interface
<ul><li>Most convenient for users</li>
<li>Internally uses engine-specific functions</li>
<li>Currently supports GLM engine</li>
</ul></li>
<li>
<strong><code><a href="reference/extract_mediation.html">extract_mediation()</a></code></strong> - Extract from fitted models
<ul><li>Generic with methods for different model types</li>
<li>Standardizes across packages</li>
<li>Returns <code>MediationData</code>
</li>
</ul></li>
<li>
<strong><code><a href="reference/bootstrap_mediation.html">bootstrap_mediation()</a></code></strong> - Bootstrap inference
<ul><li>Three methods: parametric, nonparametric, plugin</li>
<li>Parallel processing support</li>
<li>Returns <code>BootstrapResult</code>
</li>
</ul></li>
</ol><p><strong>Internal Functions:</strong></p>
<ul><li>
<code>.fit_mediation_glm()</code>: GLM engine implementation</li>
<li>
<code>.bootstrap_parametric()</code>: Parametric bootstrap</li>
<li>
<code>.bootstrap_nonparametric()</code>: Nonparametric bootstrap</li>
<li>
<code>.bootstrap_plugin()</code>: Plugin estimator</li>
<li>Utility functions for validation, formatting, etc.</li>
</ul></div>
<div class="section level3">
<h3 id="key-dependencies">Key Dependencies<a class="anchor" aria-label="anchor" href="#key-dependencies"></a></h3>
<p><strong>Required:</strong> - <strong>S7</strong>: Modern object system - <strong>stats</strong>: GLM fitting, statistical functions - <strong>methods</strong>: S4 compatibility</p>
<p><strong>Suggested:</strong> - <strong>MASS</strong>: <code>mvrnorm()</code> for parametric bootstrap - <strong>lavaan</strong>: SEM model extraction - <strong>lme4</strong>: Mixed models (future)</p>
<p><strong>Future Consideration:</strong> - <strong>OpenMx</strong>: SEM model extraction (postponed to future release)</p>
</div>
<div class="section level3">
<h3 id="explicit-namespacing">Explicit Namespacing<a class="anchor" aria-label="anchor" href="#explicit-namespacing"></a></h3>
<p><strong>CRITICAL</strong>: All non-base functions MUST use explicit namespacing:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CORRECT</span></span>
<span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">mu</span>, <span class="va">Sigma</span><span class="op">)</span></span>
<span><span class="fu">lavaan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lavaan/man/sem.html" class="external-link">sem</a></span><span class="op">(</span><span class="va">model</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># INCORRECT</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu">mvrnorm</span><span class="op">(</span><span class="va">n</span>, <span class="va">mu</span>, <span class="va">Sigma</span><span class="op">)</span></span>
<span><span class="fu">sem</span><span class="op">(</span><span class="va">model</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="important-implementation-details">Important Implementation Details<a class="anchor" aria-label="anchor" href="#important-implementation-details"></a></h2>
<div class="section level3">
<h3 id="s7-class-design">S7 Class Design<a class="anchor" aria-label="anchor" href="#s7-class-design"></a></h3>
<p><strong>MediationData</strong> (Simple Mediation): - Contains all information about simple mediation model (X -&gt; M -&gt; Y) - Path coefficients (a, b, c’) - Full parameter vector and covariance matrix - Residual variances (for Gaussian models) - Variable names and metadata - Data and sample size</p>
<p><strong>SerialMediationData</strong> (Serial Mediation): - Contains all information about serial mediation (X -&gt; M1 -&gt; M2 -&gt; … -&gt; Y) - Path coefficients: <code>a_path</code> (scalar), <code>d_path</code> (vector), <code>b_path</code> (scalar), <code>c_prime</code> (scalar) - Flexible design: <code>d_path</code> is scalar for 2 mediators, vector for 3+ - Vector properties: <code>mediators</code> (names), <code>sigma_mediators</code> (residual SDs) - List property: <code>mediator_predictors</code> (predictors for each mediator model) - Full parameter vector and covariance matrix (like MediationData)</p>
<p><strong>Design principle</strong>: Complete information for downstream packages</p>
</div>
<div class="section level3">
<h3 id="extensible-architecture-for-multiple-mediator-types">Extensible Architecture for Multiple Mediator Types<a class="anchor" aria-label="anchor" href="#extensible-architecture-for-multiple-mediator-types"></a></h3>
<p>The package uses a <strong>modular class design</strong> that allows clean extension to different mediation structures:</p>
<p><strong>Current Classes:</strong> - <code>MediationData</code>: Simple mediation (product-of-two: a * b) - <code>SerialMediationData</code>: Serial mediation (product-of-three and beyond: a * d * b, a * d21 * d32 * b, etc.)</p>
<p><strong>Design Principles:</strong> 1. <strong>Separate classes for separate structures</strong>: Each mediation type gets its own class, optimized for its use case 2. <strong>Consistent interface</strong>: All classes share common properties (<code>estimates</code>, <code>vcov</code>, metadata) 3. <strong>No hard limits</strong>: Serial mediation supports chains of any length (2, 3, k mediators) 4. <strong>Extensible validators</strong>: Each class has comprehensive validation tailored to its structure</p>
<p><strong>Future Extension Path:</strong></p>
<p>For parallel mediation (X -&gt; M1 -&gt; Y, X -&gt; M2 -&gt; Y simultaneously):</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ParallelMediationData</span> <span class="op">&lt;-</span> <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_class</a></span><span class="op">(</span></span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    a_paths <span class="op">=</span> <span class="va">numeric</span>,      <span class="co"># Vector: c(a1, a2, ...)</span></span>
<span>    b_paths <span class="op">=</span> <span class="va">numeric</span>,      <span class="co"># Vector: c(b1, b2, ...)</span></span>
<span>    c_prime <span class="op">=</span> <span class="va">numeric</span>,      <span class="co"># Scalar: X -&gt; Y direct effect</span></span>
<span>    mediators <span class="op">=</span> <span class="va">character</span>,  <span class="co"># Vector: c("M1", "M2", ...)</span></span>
<span>    <span class="co"># ... common properties (estimates, vcov, etc.)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Indirect effect = sum(a_paths * b_paths)</span></span></code></pre></div>
<p>For complex mediation (combinations of serial and parallel): - Could use graph representation or nested structure - Keep it simple: start with separate classes, add complexity only when needed</p>
</div>
<div class="section level3">
<h3 id="treatment-mediator-interaction-vanderweele-four-way-decomposition">Treatment-Mediator Interaction (VanderWeele Four-Way Decomposition)<a class="anchor" aria-label="anchor" href="#treatment-mediator-interaction-vanderweele-four-way-decomposition"></a></h3>
<p><strong>Planned for post-MVP release</strong> based on <a href="https://pubmed.ncbi.nlm.nih.gov/25000145/" class="external-link">VanderWeele (2014)</a>.</p>
<p><strong>Theoretical Foundation</strong>:</p>
<p>When treatment (X) and mediator (M) interact in their effect on outcome (Y), the total effect decomposes into four components:</p>
<table class="table"><colgroup><col width="39%"><col width="32%"><col width="28%"></colgroup><thead><tr class="header"><th>Component</th>
<th>Meaning</th>
<th>Due to</th>
</tr></thead><tbody><tr class="odd"><td><strong>CDE</strong></td>
<td>Controlled Direct Effect</td>
<td>Neither mediation nor interaction</td>
</tr><tr class="even"><td><strong>INTref</strong></td>
<td>Reference Interaction</td>
<td>Interaction only</td>
</tr><tr class="odd"><td><strong>INTmed</strong></td>
<td>Mediated Interaction</td>
<td>Both mediation and interaction</td>
</tr><tr class="even"><td><strong>PIE</strong></td>
<td>Pure Indirect Effect</td>
<td>Mediation only</td>
</tr></tbody></table><p><strong>Decomposition</strong>: TE = CDE + INTref + INTmed + PIE</p>
<p><strong>Relationships</strong>: - NDE (Natural Direct Effect) = CDE + INTref - NIE (Natural Indirect Effect) = INTmed + PIE</p>
<p><strong>Regression Models</strong>:</p>
<pre><code>Mediator:  M = β₀ + β₁X + β₂'C + εₘ
Outcome:   Y = θ₀ + θ₁X + θ₂M + θ₃(X×M) + θ₄'C + εᵧ</code></pre>
<p>**Formulas (continuous Y/M, binary X: 0→1, m*=0)**: - CDE = θ₁ (effect of X when M=0) - INTref = θ₃(β₀ + β₂’c) (interaction at reference) - INTmed = θ₃β₁ (mediated interaction) - PIE = θ₂β₁ (pure indirect effect)</p>
<p><strong>When θ₃=0</strong> (no interaction): reduces to standard mediation where CDE=NDE=θ₁ and NIE=PIE=θ₂β₁.</p>
<p><strong>InteractionMediationData Class</strong> (planned):</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">InteractionMediationData</span> <span class="op">&lt;-</span> <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_class</a></span><span class="op">(</span></span>
<span>  <span class="st">"InteractionMediationData"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"medfit"</span>,</span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co"># Core paths</span></span>
<span>    a_path <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,           <span class="co"># β₁: X → M</span></span>
<span>    b_path <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,           <span class="co"># θ₂: M → Y (main effect)</span></span>
<span>    c_prime <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,          <span class="co"># θ₁: X → Y (main effect)</span></span>
<span>    interaction <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,      <span class="co"># θ₃: X×M interaction</span></span>
<span></span>
<span>    <span class="co"># Four-way components</span></span>
<span>    cde <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,              <span class="co"># Controlled Direct Effect</span></span>
<span>    int_ref <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,          <span class="co"># Reference Interaction</span></span>
<span>    int_med <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,          <span class="co"># Mediated Interaction</span></span>
<span>    pie <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,              <span class="co"># Pure Indirect Effect</span></span>
<span></span>
<span>    <span class="co"># Derived effects</span></span>
<span>    nde <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,              <span class="co"># Natural Direct Effect</span></span>
<span>    nie <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,              <span class="co"># Natural Indirect Effect</span></span>
<span>    total_effect <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,</span>
<span></span>
<span>    <span class="co"># Reference value</span></span>
<span>    m_star <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,           <span class="co"># Reference mediator level</span></span>
<span></span>
<span>    <span class="co"># Standard properties (estimates, vcov, metadata, etc.)</span></span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Usage Pattern</strong> (planned):</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model with interaction</span></span>
<span><span class="va">fit_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">M</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">C</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">fit_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">M</span> <span class="op">+</span> <span class="va">X</span><span class="op">:</span><span class="va">M</span> <span class="op">+</span> <span class="va">C</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extraction detects interaction, returns InteractionMediationData</span></span>
<span><span class="va">med_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/extract_mediation.html">extract_mediation</a></span><span class="op">(</span></span>
<span>  <span class="va">fit_m</span>, model_y <span class="op">=</span> <span class="va">fit_y</span>,</span>
<span>  treatment <span class="op">=</span> <span class="st">"X"</span>, mediator <span class="op">=</span> <span class="st">"M"</span>,</span>
<span>  m_star <span class="op">=</span> <span class="fl">0</span>  <span class="co"># Reference mediator level</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Access four-way components</span></span>
<span><span class="va">med_int</span><span class="op">@</span><span class="va">cde</span>; <span class="va">med_int</span><span class="op">@</span><span class="va">int_ref</span>; <span class="va">med_int</span><span class="op">@</span><span class="va">int_med</span>; <span class="va">med_int</span><span class="op">@</span><span class="va">pie</span></span></code></pre></div>
<p><strong>Key References</strong>: - VanderWeele TJ (2014). A unification of mediation and interaction. <em>Epidemiology</em>, 25(5):749-61. - Valeri L, VanderWeele TJ (2013). Mediation analysis allowing for exposure-mediator interactions. <em>Psychological Methods</em>, 18(2):137-150.</p>
</div>
<div class="section level3">
<h3 id="decomposition-s7-class-planned">Decomposition S7 Class (Planned)<a class="anchor" aria-label="anchor" href="#decomposition-s7-class-planned"></a></h3>
<p><strong>Design Decision</strong>: Decomposition as separate S7 class for flexibility and custom decompositions.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Decomposition</span> <span class="op">&lt;-</span> <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_class</a></span><span class="op">(</span></span>
<span>  <span class="st">"Decomposition"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"medfit"</span>,</span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_character</a></span>,        <span class="co"># "two_way", "four_way", "custom"</span></span>
<span>    components <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_list</a></span>,       <span class="co"># Named list: list(nde = 0.3, nie = 0.2)</span></span>
<span>    total <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span>,         <span class="co"># Total effect</span></span>
<span>    formula <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_character</a></span>      <span class="co"># "NDE + NIE" or "CDE + INTref + INTmed + PIE"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  validator <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">comp_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">components</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">comp_sum</span> <span class="op">-</span> <span class="va">self</span><span class="op">@</span><span class="va">total</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1e-10</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="st">"Components must sum to total effect"</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Built-in constructors</strong>: - <code>two_way(nde, nie)</code> → NDE + NIE decomposition - <code>four_way(cde, int_ref, int_med, pie)</code> → VanderWeele 4-way - <code>custom_decomposition(...)</code> → User-defined</p>
<p><strong>MediationData</strong> stores decompositions in a list, allowing multiple:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span><span class="op">@</span><span class="va">decompositions</span><span class="op">$</span><span class="va">two_way</span>   <span class="co"># Decomposition object</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">decompositions</span><span class="op">$</span><span class="va">four_way</span>  <span class="co"># Decomposition object (when interaction present)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="user-interface-design">User Interface Design<a class="anchor" aria-label="anchor" href="#user-interface-design"></a></h3>
<p><strong>Hybrid approach</strong>: Simple strings for common cases, helper functions for advanced.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simple (default)</span></span>
<span><span class="fu">estimate_mediation</span><span class="op">(</span><span class="va">...</span>, effects <span class="op">=</span> <span class="st">"natural"</span><span class="op">)</span>  <span class="co"># NDE + NIE</span></span>
<span></span>
<span><span class="co"># Effect options</span></span>
<span><span class="va">effects</span> <span class="op">=</span> <span class="st">"natural"</span>        <span class="co"># NDE, NIE (default)</span></span>
<span><span class="va">effects</span> <span class="op">=</span> <span class="st">"interventional"</span> <span class="co"># IDE, IIE</span></span>
<span><span class="va">effects</span> <span class="op">=</span> <span class="st">"controlled"</span>     <span class="co"># CDE</span></span>
<span></span>
<span><span class="co"># Advanced (helper functions)</span></span>
<span><span class="va">effects</span> <span class="op">=</span> <span class="fu">natural_effects</span><span class="op">(</span>variant <span class="op">=</span> <span class="st">"total"</span><span class="op">)</span>  <span class="co"># TDE, TNIE</span></span>
<span><span class="va">effects</span> <span class="op">=</span> <span class="fu">controlled_effects</span><span class="op">(</span>m <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>           <span class="co"># CDE at m=5</span></span></code></pre></div>
<p><strong>Interaction handling</strong>: When <code>X:M</code> detected → compute BOTH two-way and four-way.</p>
<p><strong>Why this design?</strong> - <strong>Clean separation</strong>: Each class handles one mediation type well - <strong>No over-engineering</strong>: Don’t add complexity for hypothetical future needs - <strong>Easy to extend</strong>: Adding new classes doesn’t break existing ones - <strong>Type safety</strong>: S7 validators ensure each class is used correctly</p>
</div>
<div class="section level3">
<h3 id="engine-adapter-architecture-planned">Engine Adapter Architecture (Planned)<a class="anchor" aria-label="anchor" href="#engine-adapter-architecture-planned"></a></h3>
<p>medfit uses an <strong>adapter pattern</strong> to integrate with external packages for advanced estimation methods.</p>
<p><strong>Design principles</strong>: - Wrap validated implementations (CMAverse, tmle3) instead of reimplementing - All engines return standardized <code>MediationData</code> objects - External packages in <code>Suggests</code> (load on demand) - Engine-specific options via <code>engine_args = list(...)</code></p>
<p><strong>Engine priority</strong>:</p>
<table class="table"><colgroup><col width="24%"><col width="27%"><col width="24%"><col width="24%"></colgroup><thead><tr class="header"><th>Engine</th>
<th>Package</th>
<th>Method</th>
<th>Status</th>
</tr></thead><tbody><tr class="odd"><td><code>"regression"</code></td>
<td>(internal)</td>
<td>VanderWeele closed-form</td>
<td>MVP (default)</td>
</tr><tr class="even"><td><code>"gformula"</code></td>
<td>CMAverse</td>
<td>G-computation</td>
<td>Planned</td>
</tr><tr class="odd"><td><code>"ipw"</code></td>
<td>CMAverse</td>
<td>Inverse probability weighting</td>
<td>Planned</td>
</tr><tr class="even"><td><code>"tmle"</code></td>
<td>tmle3</td>
<td>Targeted learning</td>
<td>Future</td>
</tr><tr class="odd"><td><code>"dml"</code></td>
<td>DoubleML</td>
<td>Double machine learning</td>
<td>Future</td>
</tr></tbody></table><p><strong>Usage example</strong>:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Default regression engine</span></span>
<span><span class="fu">estimate_mediation</span><span class="op">(</span></span>
<span>  formula_y <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">M</span> <span class="op">+</span> <span class="va">C</span>,</span>
<span>  formula_m <span class="op">=</span> <span class="va">M</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">C</span>,</span>
<span>  data <span class="op">=</span> <span class="va">df</span>,</span>
<span>  treatment <span class="op">=</span> <span class="st">"X"</span>,</span>
<span>  mediator <span class="op">=</span> <span class="st">"M"</span>,</span>
<span>  effects <span class="op">=</span> <span class="st">"natural"</span>,     <span class="co"># NDE + NIE</span></span>
<span>  engine <span class="op">=</span> <span class="st">"regression"</span>    <span class="co"># Default</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CMAverse g-formula engine</span></span>
<span><span class="fu">estimate_mediation</span><span class="op">(</span></span>
<span>  <span class="va">...</span>,</span>
<span>  engine <span class="op">=</span> <span class="st">"gformula"</span>,</span>
<span>  engine_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    EMint <span class="op">=</span> <span class="cn">TRUE</span>,          <span class="co"># Exposure-mediator interaction</span></span>
<span>    nboot <span class="op">=</span> <span class="fl">500</span>            <span class="co"># CMAverse-specific bootstrap</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>See <code>planning/medfit-roadmap.md</code> Phase 7c for detailed adapter implementation.</p>
</div>
<div class="section level3">
<h3 id="model-extraction-pattern">Model Extraction Pattern<a class="anchor" aria-label="anchor" href="#model-extraction-pattern"></a></h3>
<p>All <code><a href="reference/extract_mediation.html">extract_mediation()</a></code> methods follow this pattern:</p>
<ol style="list-style-type: decimal"><li>
<strong>Validate inputs</strong> (check variable names exist)</li>
<li>
<strong>Extract parameters</strong> (a, b, c’ paths)</li>
<li>
<strong>Extract covariance matrix</strong> (for inference)</li>
<li>
<strong>Extract residual variances</strong> (if Gaussian)</li>
<li>
<strong>Get data</strong> (if available)</li>
<li>
<strong>Create MediationData</strong> object</li>
<li><strong>Return</strong></li>
</ol></div>
<div class="section level3">
<h3 id="bootstrap-implementation">Bootstrap Implementation<a class="anchor" aria-label="anchor" href="#bootstrap-implementation"></a></h3>
<p><strong>Three methods with different trade-offs</strong>:</p>
<ol style="list-style-type: decimal"><li>
<strong>Parametric</strong> (<code>method = "parametric"</code>):
<ul><li>Samples from N(θ̂, Σ̂)</li>
<li>Fast, requires normality</li>
<li>Default for most applications</li>
</ul></li>
<li>
<strong>Nonparametric</strong> (<code>method = "nonparametric"</code>):
<ul><li>Resamples data, refits models</li>
<li>Robust, computationally intensive</li>
<li>Use when normality questionable</li>
</ul></li>
<li>
<strong>Plugin</strong> (<code>method = "plugin"</code>):
<ul><li>Point estimate only, no CI</li>
<li>Fastest, for quick checks</li>
</ul></li>
</ol><p><strong>Parallel processing</strong>: - Uses <code><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">parallel::mclapply()</a></code> (Unix) or similar - Auto-detects cores if not specified - Set seed for reproducibility</p>
</div>
<div class="section level3">
<h3 id="dynamic-s7s4-dispatch">Dynamic S7/S4 Dispatch<a class="anchor" aria-label="anchor" href="#dynamic-s7s4-dispatch"></a></h3>
<p>For S4 classes from suggested packages (e.g., lavaan):</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In R/zzz.R</span></span>
<span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Register lavaan method if available</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"lavaan"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">lavaan_class</span> <span class="op">&lt;-</span> <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/as_class.html" class="external-link">as_class</a></span><span class="op">(</span><span class="fu">methods</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/methods/getClass.html" class="external-link">getClass</a></span><span class="op">(</span><span class="st">"lavaan"</span>, where <span class="op">=</span> <span class="st">"lavaan"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/method.html" class="external-link">method</a></span><span class="op">(</span><span class="va">extract_mediation</span>, <span class="va">lavaan_class</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">extract_mediation_lavaan</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Note: OpenMx integration postponed to future release</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This allows methods to work without hard dependencies.</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="testing-strategy">Testing Strategy<a class="anchor" aria-label="anchor" href="#testing-strategy"></a></h2>
<div class="section level3">
<h3 id="unit-tests-should-cover">Unit Tests Should Cover<a class="anchor" aria-label="anchor" href="#unit-tests-should-cover"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>S7 Class Validation</strong>
<ul><li>Property type checking</li>
<li>Validators catch invalid inputs</li>
<li>Edge cases (empty, NA, wrong dimensions)</li>
</ul></li>
<li>
<strong>Model Extraction</strong>
<ul><li>lm/glm extraction accuracy</li>
<li>lavaan extraction consistency</li>
<li>Identical results to manual extraction</li>
<li>Proper handling of different model types</li>
</ul></li>
<li>
<strong>Model Fitting</strong>
<ul><li>GLM engine produces valid MediationData</li>
<li>Formula parsing correct</li>
<li>Family specifications work</li>
<li>Error handling for convergence failures</li>
</ul></li>
<li>
<strong>Bootstrap Methods</strong>
<ul><li>Parametric bootstrap reproducible with seed</li>
<li>Nonparametric bootstrap reproducible with seed</li>
<li>Plugin method fast and accurate</li>
<li>CI coverage in simulations (~95% for 95% CI)</li>
<li>Parallel and sequential give same results (with seed)</li>
</ul></li>
<li>
<strong>Edge Cases</strong>
<ul><li>Small sample sizes (n &lt; 50)</li>
<li>Non-convergent models</li>
<li>Singular covariance matrices</li>
<li>Missing data</li>
<li>Zero effects</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="test-organization">Test Organization<a class="anchor" aria-label="anchor" href="#test-organization"></a></h3>
<pre><code>tests/testthat/
├── helper-test-data.R      # Test data generators
├── test-classes.R          # S7 class validation
├── test-extract-lm.R       # lm/glm extraction
├── test-extract-lavaan.R   # lavaan extraction
├── test-fit-glm.R          # GLM fitting
├── test-bootstrap.R        # Bootstrap methods
└── test-utils.R            # Utility functions</code></pre>
</div>
<div class="section level3">
<h3 id="coverage-expectations">Coverage Expectations<a class="anchor" aria-label="anchor" href="#coverage-expectations"></a></h3>
<ul><li>
<strong>Target</strong>: &gt;90% overall coverage</li>
<li>
<strong>Critical paths</strong>: 100% coverage
<ul><li>S7 class definitions</li>
<li>Core extraction functions</li>
<li>Bootstrap methods</li>
</ul></li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="integration-with-dependent-packages">Integration with Dependent Packages<a class="anchor" aria-label="anchor" href="#integration-with-dependent-packages"></a></h2>
<div class="section level3">
<h3 id="probmed-integration">probmed Integration<a class="anchor" aria-label="anchor" href="#probmed-integration"></a></h3>
<p><strong>probmed will</strong>: - Import medfit - Replace extraction code with <code><a href="reference/extract_mediation.html">medfit::extract_mediation()</a></code> - Replace bootstrap code with <code><a href="reference/bootstrap_mediation.html">medfit::bootstrap_mediation()</a></code> - Keep its formula interface as wrapper around medfit - Add P_med-specific computation</p>
<p><strong>Backward compatibility critical</strong>: probmed users should see no changes</p>
</div>
<div class="section level3">
<h3 id="rmediation-integration">RMediation Integration<a class="anchor" aria-label="anchor" href="#rmediation-integration"></a></h3>
<p><strong>RMediation will</strong>: - Import medfit - Replace extraction code with <code><a href="reference/extract_mediation.html">medfit::extract_mediation()</a></code> - Optionally use bootstrap utilities - Keep its unique methods (DOP, MBCO, MC)</p>
</div>
<div class="section level3">
<h3 id="medrobust-integration">medrobust Integration<a class="anchor" aria-label="anchor" href="#medrobust-integration"></a></h3>
<p><strong>medrobust will</strong>: - Suggest medfit (optional) - Optionally use for naive estimates - Keep its unique methods (bounds, falsification)</p>
</div>
<div class="section level3">
<h3 id="coordination">Coordination<a class="anchor" aria-label="anchor" href="#coordination"></a></h3>
<p><strong>When making changes that affect</strong>: - S7 class structure → Coordinate with all packages - Extraction API → Coordinate with probmed and RMediation - Bootstrap API → Coordinate with all packages</p>
<p><strong>Versioning</strong>: - Use semantic versioning - Breaking changes → major version bump - New features → minor version bump - Bug fixes → patch version bump</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="development-roadmap">Development Roadmap<a class="anchor" aria-label="anchor" href="#development-roadmap"></a></h2>
<p>See <code>planning/medfit-roadmap.md</code> for detailed implementation plan.</p>
<div class="section level3">
<h3 id="current-phase-mvp-development">Current Phase: MVP Development<a class="anchor" aria-label="anchor" href="#current-phase-mvp-development"></a></h3>
<ul class="task-list"><li><label><input type="checkbox" checked>Package skeleton</label></li>
<li><label><input type="checkbox">S7 classes implemented</label></li>
<li><label><input type="checkbox">Extraction methods (lm/glm, lavaan)</label></li>
<li><label><input type="checkbox">Fitting API (GLM engine)</label></li>
<li><label><input type="checkbox">Bootstrap infrastructure</label></li>
<li><label><input type="checkbox">Comprehensive tests</label></li>
<li><label><input type="checkbox">Documentation and vignettes</label></li>
</ul></div>
<div class="section level3">
<h3 id="future-enhancements">Future Enhancements<a class="anchor" aria-label="anchor" href="#future-enhancements"></a></h3>
<ul class="task-list"><li><label><input type="checkbox">lmer engine (mixed models)</label></li>
<li><label><input type="checkbox">brms engine (Bayesian)</label></li>
<li><label><input type="checkbox">Additional extraction methods</label></li>
<li><label><input type="checkbox">Performance optimizations</label></li>
<li><label><input type="checkbox">Extended documentation</label></li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="statistical-assumptions">Statistical Assumptions<a class="anchor" aria-label="anchor" href="#statistical-assumptions"></a></h2>
<div class="section level3">
<h3 id="key-assumptions-for-inference">Key Assumptions for Inference<a class="anchor" aria-label="anchor" href="#key-assumptions-for-inference"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Correct model specification</strong>
<ul><li>Mediator model correctly specified</li>
<li>Outcome model correctly specified</li>
<li>Appropriate family/link functions</li>
</ul></li>
<li>
<strong>Parameter normality</strong> (for parametric bootstrap)
<ul><li>(θ̂) ~ N(θ, Σ)</li>
<li>Generally holds for large n (CLT)</li>
<li>Check with Q-Q plots</li>
</ul></li>
<li>
<strong>No unmeasured confounding</strong> (for causal interpretation)
<ul><li>Standard causal mediation assumptions</li>
<li>Not testable, requires subject-matter knowledge</li>
<li>
<strong>Note</strong>: medfit computes statistics; causal interpretation is user’s responsibility</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="diagnostics">Diagnostics<a class="anchor" aria-label="anchor" href="#diagnostics"></a></h3>
<p>Users should: - Check bootstrap distributions (histograms, Q-Q plots) - Verify model convergence - Assess residual plots - Consider sensitivity analyses</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="common-pitfalls-to-avoid">Common Pitfalls to Avoid<a class="anchor" aria-label="anchor" href="#common-pitfalls-to-avoid"></a></h2>
<ol style="list-style-type: decimal"><li>
<strong>Don’t mix up variable names</strong>: Ensure treatment/mediator names match model</li>
<li>
<strong>Don’t ignore convergence warnings</strong>: Check <code>converged</code> property</li>
<li>
<strong>Don’t use plugin for inference</strong>: Always bootstrap for CIs</li>
<li>
<strong>Don’t skip input validation</strong>: Use validators rigorously</li>
<li>
<strong>Don’t break backward compatibility</strong>: Coordinate with dependent packages</li>
<li>
<strong>Don’t suppress errors/warnings without understanding them</strong>: When encountering R CMD check NOTEs, warnings, or errors during package development:
<ul><li>
<strong>FIRST</strong>: Research the issue to understand the root cause</li>
<li>
<strong>THEN</strong>: Fix the underlying problem properly</li>
<li>
<strong>NEVER</strong>: Use <code><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages()</a></code>, <code><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings()</a></code>, or <code><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch()</a></code> to hide issues without understanding them</li>
<li>Example: The “Overwriting method” S7 message was initially suppressed, but the real fix was proper <code>.onLoad()</code> registration order</li>
</ul></li>
</ol><hr></div>
<div class="section level2">
<h2 id="key-mathematical-formulas">Key Mathematical Formulas<a class="anchor" aria-label="anchor" href="#key-mathematical-formulas"></a></h2>
<div class="section level3">
<h3 id="indirect-effect">Indirect Effect<a class="anchor" aria-label="anchor" href="#indirect-effect"></a></h3>
<p>For simple mediation (X → M → Y):</p>
<pre><code>Indirect effect = a × b</code></pre>
<p>where: - a = effect of X on M - b = effect of M on Y (controlling for X)</p>
</div>
<div class="section level3">
<h3 id="parametric-bootstrap">Parametric Bootstrap<a class="anchor" aria-label="anchor" href="#parametric-bootstrap"></a></h3>
<p>Sample from:</p>
<pre><code>θ* ~ N(θ̂, Σ̂)</code></pre>
<p>Compute statistic for each θ*, extract quantiles for CI.</p>
</div>
<div class="section level3">
<h3 id="nonparametric-bootstrap">Nonparametric Bootstrap<a class="anchor" aria-label="anchor" href="#nonparametric-bootstrap"></a></h3>
<ol style="list-style-type: decimal"><li>Resample data: D* ~ D (with replacement)</li>
<li>Refit models on D*</li>
<li>Extract θ*</li>
<li>Compute statistic</li>
<li>Repeat, extract quantiles for CI</li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="ecosystem-coordination">Ecosystem Coordination<a class="anchor" aria-label="anchor" href="#ecosystem-coordination"></a></h2>
<p>medfit is the <strong>foundation package</strong> for the mediationverse ecosystem.</p>
<div class="section level3">
<h3 id="central-planning-documents">Central Planning Documents<a class="anchor" aria-label="anchor" href="#central-planning-documents"></a></h3>
<p>All ecosystem-wide coordination is managed in <code>/Users/dt/mediation-planning/</code>:</p>
<table class="table"><colgroup><col width="52%"><col width="47%"></colgroup><thead><tr class="header"><th>Document</th>
<th>Purpose</th>
</tr></thead><tbody><tr class="odd"><td><code>ECOSYSTEM-COORDINATION.md</code></td>
<td>Version matrix, change propagation, release timeline</td>
</tr><tr class="even"><td><code>MONTHLY-CHECKLIST.md</code></td>
<td>Recurring ecosystem health checks</td>
</tr><tr class="odd"><td><code>templates/README-template.md</code></td>
<td>Standardized README structure</td>
</tr><tr class="even"><td><code>templates/NEWS-template.md</code></td>
<td>Standardized NEWS.md format</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="change-propagation">Change Propagation<a class="anchor" aria-label="anchor" href="#change-propagation"></a></h3>
<p>When making changes to medfit that may affect dependent packages:</p>
<ol style="list-style-type: decimal"><li>
<strong>Document</strong> - Update NEWS.md with ecosystem notes</li>
<li>
<strong>Test</strong> - Run <code>revdepcheck::revdep_check()</code> locally</li>
<li>
<strong>Notify</strong> - For breaking changes, create issue with 2-month notice</li>
<li>
<strong>Coordinate</strong> - Schedule dependent package updates before release</li>
</ol></div>
<div class="section level3">
<h3 id="cross-package-ci">Cross-Package CI<a class="anchor" aria-label="anchor" href="#cross-package-ci"></a></h3>
<p>The <code>.github/workflows/revdep-check.yaml</code> workflow runs weekly to test: - probmed against medfit @main - RMediation against medfit @main - medrobust against medfit @main</p>
</div>
<div class="section level3">
<h3 id="breaking-change-protocol">Breaking Change Protocol<a class="anchor" aria-label="anchor" href="#breaking-change-protocol"></a></h3>
<ol style="list-style-type: decimal"><li>Create GitHub issue with <code>[BREAKING]</code> prefix</li>
<li>Minimum 2-month deprecation period</li>
<li>Use <code><a href="https://lifecycle.r-lib.org/reference/deprecate_soft.html" class="external-link">lifecycle::deprecate_warn()</a></code> for soft deprecation</li>
<li>Document migration path in vignette or NEWS.md</li>
<li>Update version matrix in ECOSYSTEM-COORDINATION.md</li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="additional-resources">Additional Resources<a class="anchor" aria-label="anchor" href="#additional-resources"></a></h2>
<div class="section level3">
<h3 id="package-ecosystem-documentation">Package Ecosystem Documentation<a class="anchor" aria-label="anchor" href="#package-ecosystem-documentation"></a></h3>
<ul><li>
<strong>Central</strong>: <code>/Users/dt/mediation-planning/</code> - Ecosystem-wide strategy</li>
<li>
<strong>probmed</strong>: <code>probmed/CLAUDE.md</code>, <code>probmed/planning/</code>
</li>
<li>
<strong>RMediation</strong>: <code>rmediation/CLAUDE.md</code>
</li>
<li>
<strong>medrobust</strong>: <code>medrobust/CLAUDE.md</code>
</li>
<li>
<strong>medsim</strong>: Simulation infrastructure for testing methods</li>
</ul></div>
<div class="section level3">
<h3 id="key-planning-documents">Key Planning Documents<a class="anchor" aria-label="anchor" href="#key-planning-documents"></a></h3>
<p>Located in <code>planning/</code>: - <strong>medfit-roadmap.md</strong>: Detailed implementation plan - <strong>ECOSYSTEM.md</strong>: Connection to dependent packages</p>
</div>
<div class="section level3">
<h3 id="related-packages">Related Packages<a class="anchor" aria-label="anchor" href="#related-packages"></a></h3>
<table class="table"><colgroup><col width="31%"><col width="37%"><col width="31%"></colgroup><thead><tr class="header"><th>Package</th>
<th>Repository</th>
<th>Purpose</th>
</tr></thead><tbody><tr class="odd"><td>probmed</td>
<td><a href="https://github.com/data-wise/probmed" class="external-link uri">https://github.com/data-wise/probmed</a></td>
<td>Probabilistic effect size (P_med)</td>
</tr><tr class="even"><td>RMediation</td>
<td><a href="https://github.com/data-wise/rmediation" class="external-link uri">https://github.com/data-wise/rmediation</a></td>
<td>Confidence intervals (DOP, MBCO)</td>
</tr><tr class="odd"><td>medrobust</td>
<td><a href="https://github.com/data-wise/medrobust" class="external-link uri">https://github.com/data-wise/medrobust</a></td>
<td>Sensitivity analysis</td>
</tr><tr class="even"><td>medsim</td>
<td><a href="https://github.com/data-wise/medsim" class="external-link uri">https://github.com/data-wise/medsim</a></td>
<td>Simulation infrastructure</td>
</tr></tbody></table><hr></div>
</div>
<div class="section level2">
<h2 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a></h2>
<div class="section level3">
<h3 id="lavaan-dispatch-issues">lavaan Dispatch Issues<a class="anchor" aria-label="anchor" href="#lavaan-dispatch-issues"></a></h3>
<p>If <code><a href="reference/extract_mediation.html">extract_mediation()</a></code> doesn’t work with lavaan objects: - Check that lavaan is installed - Verify <code>.onLoad()</code> is registering the method - Test with <code>methods(extract_mediation)</code> to see registered methods</p>
</div>
<div class="section level3">
<h3 id="bootstrap-reproducibility">Bootstrap Reproducibility<a class="anchor" aria-label="anchor" href="#bootstrap-reproducibility"></a></h3>
<p>If bootstrap results not reproducible: - Ensure seed is set before calling - Check that parallel=FALSE or seed is set before parallel call - Verify n_boot is the same</p>
</div>
<div class="section level3">
<h3 id="performance-issues">Performance Issues<a class="anchor" aria-label="anchor" href="#performance-issues"></a></h3>
<p>If bootstrap is slow: - Use <code>parallel=TRUE</code> - Consider parametric instead of nonparametric - Reduce <code>n_boot</code> for testing (use 1000+ for production)</p>
</div>
<div class="section level3">
<h3 id="r-file-loading-order-issues">R File Loading Order Issues<a class="anchor" aria-label="anchor" href="#r-file-loading-order-issues"></a></h3>
<p>If you get “object not found” errors during package load: - S7 generics MUST be defined before methods that use them - R files load alphabetically, so use prefixes: <code>aaa-imports.R</code>, <code>aab-generics.R</code> - Methods in <code>extract-*.R</code> require generics from <code>aab-generics.R</code> to load first</p>
</div>
<div class="section level3">
<h3 id="lavaan-extraction-issues">lavaan Extraction Issues<a class="anchor" aria-label="anchor" href="#lavaan-extraction-issues"></a></h3>
<p>If lavaan extraction fails with dimension errors: - <strong>Parameter label conflicts</strong>: When lavaan model uses labels like <code>M ~ a*X</code>, the parameter is already named “a” - Don’t add duplicate aliases that conflict with existing parameter names - Check <code>names(lavaan::coef(fit))</code> to see existing names - <strong>Data type issues</strong>: <code>lavaan::lavInspect(object, "data")</code> may return matrix or numeric, not data.frame - Convert to data.frame or return NULL if not convertible</p>
</div>
<div class="section level3">
<h3 id="s7-class-has-not-been-registered-with-s4-error">S7 “Class has not been registered with S4” Error<a class="anchor" aria-label="anchor" href="#s7-class-has-not-been-registered-with-s4-error"></a></h3>
<p>If you see this error during package installation: 1. Ensure <code>S7::S4_register(ClassName)</code> is called in <code>.onLoad()</code> for each S7 class 2. Call <code>S4_register()</code> BEFORE <code>methods_register()</code> 3. Import full <code>methods</code> package: <code>@import methods</code></p>
</div>
<div class="section level3">
<h3 id="s7-overwriting-method-messages">S7 “Overwriting method” Messages<a class="anchor" aria-label="anchor" href="#s7-overwriting-method-messages"></a></h3>
<p>During <code>devtools::load_all()</code>, you may see “Overwriting method” messages: - This is a <strong>known development-time issue</strong> (GitHub #474) - Does NOT affect installed packages - Caused by methods being registered twice: during sourcing and in <code>.onLoad()</code> - Do NOT suppress with <code><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages()</a></code> - the behavior is correct</p>
<hr><p><strong>Last Updated</strong>: 2025-12-03 <strong>Maintained by</strong>: medfit development team</p>
<p><strong>Workflow Keywords:</strong> - <code>doc</code> - Update planning documentation, README, and NEWS - <code>check</code> - Run R CMD check –as-cran, build/preview website, and check GitHub Actions status - <code>sync</code> - Commit and push changes to remote</p>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://orcid.org/0000-0001-8523-7776" class="external-link">Davood Tofighi</a> Built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>Version {version}</p>
</div>

    </footer></div>





  
</body></html>

