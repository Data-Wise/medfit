<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md for medfit Package • medfit</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md for medfit Package"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">medfit</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="articles/medfit.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/introduction.html">Introduction to medfit</a></li>
    <li><a class="dropdown-item" href="articles/extraction.html">Model Extraction</a></li>
    <li><a class="dropdown-item" href="articles/bootstrap.html">Bootstrap Inference</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">News</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/data-wise/medfit/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>CLAUDE.md for medfit Package</h1>
      <small class="dont-index">Source: <a href="https://github.com/data-wise/medfit/blob/dev/CLAUDE.md" class="external-link"><code>CLAUDE.md</code></a></small>
    </div>

<div id="claudemd-for-medfit-package" class="section level1">

<p>This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.</p>
<hr><div class="section level2">
<h2 id="about-this-package">About This Package<a class="anchor" aria-label="anchor" href="#about-this-package"></a></h2>
<p><strong>medfit</strong> is a foundation package providing unified infrastructure for fitting mediation models, extracting path coefficients, and performing bootstrap inference. It eliminates redundancy across the mediation analysis ecosystem (probmed, RMediation, medrobust) by providing shared S7-based classes and methods.</p>
<div class="section level3">
<h3 id="core-mission">Core Mission<a class="anchor" aria-label="anchor" href="#core-mission"></a></h3>
<p>Provide clean, efficient, type-safe infrastructure for mediation model handling that can be shared across multiple effect size computation packages, reducing code duplication and ensuring consistency.</p>
</div>
<div class="section level3">
<h3 id="package-ecosystem-context">Package Ecosystem Context<a class="anchor" aria-label="anchor" href="#package-ecosystem-context"></a></h3>
<p><strong>medfit is the foundation for</strong>:</p>
<ol style="list-style-type: decimal"><li>
<strong>probmed</strong> - P_med (probabilistic effect size)
<ul><li>Uses medfit for: model fitting, extraction, bootstrap</li>
<li>Adds: P_med computation, visualization</li>
</ul></li>
<li>
<strong>RMediation</strong> - Confidence intervals (DOP, MBCO)
<ul><li>Uses medfit for: model extraction, bootstrap utilities</li>
<li>Adds: Distribution of Product, MBCO tests, MC methods</li>
</ul></li>
<li>
<strong>medrobust</strong> - Sensitivity analysis
<ul><li>Uses medfit for: optional naive estimates, bootstrap</li>
<li>Adds: Bounds computation, falsification tests</li>
</ul></li>
</ol><p><strong>Key Principle</strong>: medfit provides infrastructure, not effect sizes. Each dependent package focuses on its unique methodological contribution.</p>
</div>
<div class="section level3">
<h3 id="key-references">Key References<a class="anchor" aria-label="anchor" href="#key-references"></a></h3>
<ul><li>Tofighi, D. (2025). medfit: Infrastructure for mediation analysis in R. (In preparation)</li>
<li>Related: probmed, RMediation, medrobust package documentation</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="common-development-commands">Common Development Commands<a class="anchor" aria-label="anchor" href="#common-development-commands"></a></h2>
<p><strong>Preferred Tools</strong>: Use <code>devtools</code> and <code>usethis</code> packages for all R package development tasks. These provide convenient wrappers and best practices for package development workflows.</p>
<div class="section level3">
<h3 id="package-building-and-checking">Package Building and Checking<a class="anchor" aria-label="anchor" href="#package-building-and-checking"></a></h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install package dependencies</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_deps</span><span class="op">(</span>dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check package (standard R CMD check)</span></span>
<span><span class="fu">rcmdcheck</span><span class="fu">::</span><span class="fu">rcmdcheck</span><span class="op">(</span>args <span class="op">=</span> <span class="st">"--no-manual"</span>, error_on <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build package</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">build</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Install and reload during development</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">load_all</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a></h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate documentation from roxygen2 comments</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">document</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build vignettes</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">build_vignettes</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build pkgdown site</span></span>
<span><span class="fu">pkgdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">build_site</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a></h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run all tests</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">test</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run specific test file</span></span>
<span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_file.html" class="external-link">test_file</a></span><span class="op">(</span><span class="st">"tests/testthat/test-classes.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check coverage</span></span>
<span><span class="fu">covr</span><span class="fu">::</span><span class="fu"><a href="http://covr.r-lib.org/reference/package_coverage.html" class="external-link">package_coverage</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="coding-standards">Coding Standards<a class="anchor" aria-label="anchor" href="#coding-standards"></a></h2>
<div class="section level3">
<h3 id="r-version-and-style">R Version and Style<a class="anchor" aria-label="anchor" href="#r-version-and-style"></a></h3>
<ul><li>
<strong>Minimum R version</strong>: 4.1.0 (native pipe <code>|&gt;</code> support)</li>
<li>
<strong>OOP Framework</strong>: S7 (modern object system)</li>
<li>
<strong>Style</strong>: tidyverse style guide with native pipe</li>
<li>
<strong>Roxygen2</strong>: Use roxygen2 for documentation (&gt;= 7.3.0)</li>
<li>
<strong>Clarity priority</strong>: Code must be readable and maintainable</li>
</ul></div>
<div class="section level3">
<h3 id="naming-conventions">Naming Conventions<a class="anchor" aria-label="anchor" href="#naming-conventions"></a></h3>
<p>The package uses <strong>snake_case</strong> consistently:</p>
<p><strong>Functions:</strong> - Main exports: <code><a href="reference/fit_mediation.html">fit_mediation()</a></code>, <code><a href="reference/extract_mediation.html">extract_mediation()</a></code>, <code><a href="reference/bootstrap_mediation.html">bootstrap_mediation()</a></code> - Internal functions prefix with dot: <code>.fit_mediation_glm()</code>, <code>.bootstrap_parametric()</code></p>
<p><strong>Arguments:</strong> - <code>formula_y</code>, <code>formula_m</code> for model specifications - <code>treatment</code>, <code>mediator</code>, <code>outcome</code> for variable names - <code>engine</code> for modeling engine: “glm”, “lmer”, “brms” - <code>method</code> for inference method: “parametric”, “nonparametric”, “plugin” - <code>n_boot</code> for number of bootstrap samples - <code>ci_level</code> for confidence level (default: 0.95)</p>
<p><strong>S7 Classes:</strong> - CamelCase: <code>MediationData</code>, <code>BootstrapResult</code> - Properties use snake_case: <code>@a_path</code>, <code>@boot_estimates</code></p>
</div>
<div class="section level3">
<h3 id="code-organization">Code Organization<a class="anchor" aria-label="anchor" href="#code-organization"></a></h3>
<pre><code>R/
├── aaa-imports.R           # Package imports and setup
├── medfit-package.R        # Package documentation
├── classes.R               # S7 class definitions
├── generics.R              # S7 generic functions
├── fit-glm.R              # GLM engine implementation
├── extract-lm.R           # lm/glm extraction
├── extract-lavaan.R       # lavaan extraction
├── extract-openmx.R       # OpenMx extraction (if included)
├── bootstrap.R            # Bootstrap infrastructure
├── utils.R                # Utility functions
└── zzz.R                  # .onLoad() for dynamic dispatch</code></pre>
<hr></div>
</div>
<div class="section level2">
<h2 id="code-architecture">Code Architecture<a class="anchor" aria-label="anchor" href="#code-architecture"></a></h2>
<div class="section level3">
<h3 id="s7-object-system">S7 Object System<a class="anchor" aria-label="anchor" href="#s7-object-system"></a></h3>
<p>The package uses S7 for type-safe, modern object-oriented programming.</p>
<p><strong>Key S7 Classes:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong><code>MediationData</code></strong> - Standardized mediation model structure
<ul><li>Properties: <code>a_path</code>, <code>b_path</code>, <code>c_prime</code>, <code>estimates</code>, <code>vcov</code>, <code>data</code>, etc.</li>
<li>Validator ensures internal consistency</li>
<li>Base class that dependent packages can extend</li>
</ul></li>
<li>
<strong><code>BootstrapResult</code></strong> - Bootstrap inference results
<ul><li>Properties: <code>estimate</code>, <code>ci_lower</code>, <code>ci_upper</code>, <code>boot_estimates</code>, <code>method</code>
</li>
<li>Validator checks consistency</li>
<li>Used by all packages for inference</li>
</ul></li>
</ol><p><strong>S7 Generics:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong><code><a href="reference/extract_mediation.html">extract_mediation()</a></code></strong> - Extract mediation structure from models
<ul><li>Methods: <code>lm</code>, <code>glm</code>, <code>lavaan</code>, (future: <code>lmerMod</code>, <code>brmsfit</code>)</li>
<li>Returns: <code>MediationData</code> object</li>
</ul></li>
<li>
<strong><code><a href="reference/fit_mediation.html">fit_mediation()</a></code></strong> - Fit mediation models
<ul><li>Dispatcher to engine-specific functions</li>
<li>Returns: <code>MediationData</code> object</li>
</ul></li>
<li>
<strong><code><a href="reference/bootstrap_mediation.html">bootstrap_mediation()</a></code></strong> - Perform bootstrap inference
<ul><li>Methods: parametric, nonparametric, plugin</li>
<li>Returns: <code>BootstrapResult</code> object</li>
</ul></li>
</ol><p><strong>S7 Documentation Patterns:</strong></p>
<p>When documenting S7 classes and methods with roxygen2:</p>
<ol style="list-style-type: decimal"><li>
<p><strong>S7 Class Constructors</strong>: Use explicit <code>@param</code> tags for all properties</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' MediationData S7 Class</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @description</span></span>
<span><span class="co">#' S7 class containing standardized mediation model structure</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param a_path Numeric scalar: effect of treatment on mediator</span></span>
<span><span class="co">#' @param b_path Numeric scalar: effect of mediator on outcome</span></span>
<span><span class="co">#' # ... document ALL properties explicitly</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return A MediationData S7 object</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">MediationData</span> <span class="op">&lt;-</span> <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_class</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>S7 Methods</strong>: Use <code>@noRd</code> to prevent namespace export issues</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Print Method for MediationData</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x A MediationData object</span></span>
<span><span class="co">#' @param ... Additional arguments (ignored)</span></span>
<span><span class="co">#' @noRd</span></span>
<span><span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/method.html" class="external-link">method</a></span><span class="op">(</span><span class="va">print</span>, <span class="va">MediationData</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> <span class="va">...</span> <span class="op">}</span></span></code></pre></div>
<p><strong>Important</strong>:</p>
<ul><li>Do NOT use <code>@export</code> for S7 methods (causes namespace errors)</li>
<li>Do NOT use <code>@name</code> tag (causes duplicate .Rd files)</li>
<li>Use <code>@noRd</code> to document internally without generating .Rd files</li>
<li>S7 methods work via automatic dispatch, not namespace exports</li>
</ul></li>
<li>
<p><strong>S7 Generics</strong>: Only document generic parameters, not method-specific ones</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Extract Mediation Structure</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param object Fitted model object</span></span>
<span><span class="co">#' @param ... Additional arguments passed to methods. Common arguments include:</span></span>
<span><span class="co">#'   - `treatment`: Character string (document in prose, not as @param)</span></span>
<span><span class="co">#'   - `mediator`: Character string (document in prose, not as @param)</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">extract_mediation</span> <span class="op">&lt;-</span> <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_generic.html" class="external-link">new_generic</a></span><span class="op">(</span><span class="st">"extract_mediation"</span>, dispatch_args <span class="op">=</span> <span class="st">"object"</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Testing S7 Methods</strong>: Method dispatch may not work in installed package context</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"MediationData print method works"</span>, <span class="op">{</span></span>
<span>  <span class="fu">skip_if_not</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"S7 method dispatch issue in non-interactive mode"</span><span class="op">)</span></span>
<span>  <span class="co"># ... test code</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>S7 Method Registration in .onLoad()</strong>: Do NOT use <code><a href="https://rconsortium.github.io/S7/reference/methods_register.html" class="external-link">S7::methods_register()</a></code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># INCORRECT - causes load-time errors</span></span>
<span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/methods_register.html" class="external-link">methods_register</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># DON'T DO THIS</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># CORRECT - rely on S4 registration</span></span>
<span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># S7 methods work automatically after S7::S4_register() in class definitions</span></span>
<span>  <span class="co"># No additional registration needed</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Why</strong>:</p>
<ul><li>
<code><a href="https://rconsortium.github.io/S7/reference/methods_register.html" class="external-link">S7::methods_register()</a></code> in <code>.onLoad()</code> tries to register methods before classes are defined</li>
<li>S7 methods are defined at package build time, not load time</li>
<li>S7 method dispatch works automatically after <code><a href="https://rconsortium.github.io/S7/reference/S4_register.html" class="external-link">S7::S4_register()</a></code> calls</li>
<li>Always call <code>S7::S4_register(ClassName)</code> immediately after each class definition</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="core-function-hierarchy">Core Function Hierarchy<a class="anchor" aria-label="anchor" href="#core-function-hierarchy"></a></h3>
<p><strong>User-Facing Functions:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong><code><a href="reference/fit_mediation.html">fit_mediation()</a></code></strong> - Fit models with formula interface
<ul><li>Most convenient for users</li>
<li>Internally uses engine-specific functions</li>
<li>Currently supports GLM engine</li>
</ul></li>
<li>
<strong><code><a href="reference/extract_mediation.html">extract_mediation()</a></code></strong> - Extract from fitted models
<ul><li>Generic with methods for different model types</li>
<li>Standardizes across packages</li>
<li>Returns <code>MediationData</code>
</li>
</ul></li>
<li>
<strong><code><a href="reference/bootstrap_mediation.html">bootstrap_mediation()</a></code></strong> - Bootstrap inference
<ul><li>Three methods: parametric, nonparametric, plugin</li>
<li>Parallel processing support</li>
<li>Returns <code>BootstrapResult</code>
</li>
</ul></li>
</ol><p><strong>Internal Functions:</strong></p>
<ul><li>
<code>.fit_mediation_glm()</code>: GLM engine implementation</li>
<li>
<code>.bootstrap_parametric()</code>: Parametric bootstrap</li>
<li>
<code>.bootstrap_nonparametric()</code>: Nonparametric bootstrap</li>
<li>
<code>.bootstrap_plugin()</code>: Plugin estimator</li>
<li>Utility functions for validation, formatting, etc.</li>
</ul></div>
<div class="section level3">
<h3 id="key-dependencies">Key Dependencies<a class="anchor" aria-label="anchor" href="#key-dependencies"></a></h3>
<p><strong>Required:</strong> - <strong>S7</strong>: Modern object system - <strong>stats</strong>: GLM fitting, statistical functions - <strong>methods</strong>: S4 compatibility</p>
<p><strong>Suggested:</strong> - <strong>MASS</strong>: <code>mvrnorm()</code> for parametric bootstrap - <strong>lavaan</strong>: SEM model extraction - <strong>OpenMx</strong>: SEM model extraction - <strong>lme4</strong>: Mixed models (future)</p>
</div>
<div class="section level3">
<h3 id="explicit-namespacing">Explicit Namespacing<a class="anchor" aria-label="anchor" href="#explicit-namespacing"></a></h3>
<p><strong>CRITICAL</strong>: All non-base functions MUST use explicit namespacing:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CORRECT</span></span>
<span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">mu</span>, <span class="va">Sigma</span><span class="op">)</span></span>
<span><span class="fu">lavaan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lavaan/man/sem.html" class="external-link">sem</a></span><span class="op">(</span><span class="va">model</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># INCORRECT</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu">mvrnorm</span><span class="op">(</span><span class="va">n</span>, <span class="va">mu</span>, <span class="va">Sigma</span><span class="op">)</span></span>
<span><span class="fu">sem</span><span class="op">(</span><span class="va">model</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="important-implementation-details">Important Implementation Details<a class="anchor" aria-label="anchor" href="#important-implementation-details"></a></h2>
<div class="section level3">
<h3 id="s7-class-design">S7 Class Design<a class="anchor" aria-label="anchor" href="#s7-class-design"></a></h3>
<p><strong>MediationData</strong> is the central data structure: - Contains all information about mediation model - Path coefficients (a, b, c’) - Full parameter vector and covariance matrix - Residual variances (for Gaussian models) - Variable names and metadata - Data and sample size</p>
<p><strong>Design principle</strong>: Complete information for downstream packages</p>
</div>
<div class="section level3">
<h3 id="model-extraction-pattern">Model Extraction Pattern<a class="anchor" aria-label="anchor" href="#model-extraction-pattern"></a></h3>
<p>All <code><a href="reference/extract_mediation.html">extract_mediation()</a></code> methods follow this pattern:</p>
<ol style="list-style-type: decimal"><li>
<strong>Validate inputs</strong> (check variable names exist)</li>
<li>
<strong>Extract parameters</strong> (a, b, c’ paths)</li>
<li>
<strong>Extract covariance matrix</strong> (for inference)</li>
<li>
<strong>Extract residual variances</strong> (if Gaussian)</li>
<li>
<strong>Get data</strong> (if available)</li>
<li>
<strong>Create MediationData</strong> object</li>
<li><strong>Return</strong></li>
</ol></div>
<div class="section level3">
<h3 id="bootstrap-implementation">Bootstrap Implementation<a class="anchor" aria-label="anchor" href="#bootstrap-implementation"></a></h3>
<p><strong>Three methods with different trade-offs</strong>:</p>
<ol style="list-style-type: decimal"><li>
<strong>Parametric</strong> (<code>method = "parametric"</code>):
<ul><li>Samples from N(θ̂, Σ̂)</li>
<li>Fast, requires normality</li>
<li>Default for most applications</li>
</ul></li>
<li>
<strong>Nonparametric</strong> (<code>method = "nonparametric"</code>):
<ul><li>Resamples data, refits models</li>
<li>Robust, computationally intensive</li>
<li>Use when normality questionable</li>
</ul></li>
<li>
<strong>Plugin</strong> (<code>method = "plugin"</code>):
<ul><li>Point estimate only, no CI</li>
<li>Fastest, for quick checks</li>
</ul></li>
</ol><p><strong>Parallel processing</strong>: - Uses <code><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">parallel::mclapply()</a></code> (Unix) or similar - Auto-detects cores if not specified - Set seed for reproducibility</p>
</div>
<div class="section level3">
<h3 id="dynamic-s7s4-dispatch">Dynamic S7/S4 Dispatch<a class="anchor" aria-label="anchor" href="#dynamic-s7s4-dispatch"></a></h3>
<p>For S4 classes from suggested packages (lavaan, OpenMx):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In R/zzz.R</span></span>
<span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Register lavaan method if available</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"lavaan"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">lavaan_class</span> <span class="op">&lt;-</span> <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/as_class.html" class="external-link">as_class</a></span><span class="op">(</span><span class="fu">methods</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/methods/getClass.html" class="external-link">getClass</a></span><span class="op">(</span><span class="st">"lavaan"</span>, where <span class="op">=</span> <span class="st">"lavaan"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/method.html" class="external-link">method</a></span><span class="op">(</span><span class="va">extract_mediation</span>, <span class="va">lavaan_class</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">extract_mediation_lavaan</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Register OpenMx method if available</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"OpenMx"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Similar pattern</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This allows methods to work without hard dependencies.</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="testing-strategy">Testing Strategy<a class="anchor" aria-label="anchor" href="#testing-strategy"></a></h2>
<div class="section level3">
<h3 id="unit-tests-should-cover">Unit Tests Should Cover<a class="anchor" aria-label="anchor" href="#unit-tests-should-cover"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>S7 Class Validation</strong>
<ul><li>Property type checking</li>
<li>Validators catch invalid inputs</li>
<li>Edge cases (empty, NA, wrong dimensions)</li>
</ul></li>
<li>
<strong>Model Extraction</strong>
<ul><li>lm/glm extraction accuracy</li>
<li>lavaan extraction consistency</li>
<li>Identical results to manual extraction</li>
<li>Proper handling of different model types</li>
</ul></li>
<li>
<strong>Model Fitting</strong>
<ul><li>GLM engine produces valid MediationData</li>
<li>Formula parsing correct</li>
<li>Family specifications work</li>
<li>Error handling for convergence failures</li>
</ul></li>
<li>
<strong>Bootstrap Methods</strong>
<ul><li>Parametric bootstrap reproducible with seed</li>
<li>Nonparametric bootstrap reproducible with seed</li>
<li>Plugin method fast and accurate</li>
<li>CI coverage in simulations (~95% for 95% CI)</li>
<li>Parallel and sequential give same results (with seed)</li>
</ul></li>
<li>
<strong>Edge Cases</strong>
<ul><li>Small sample sizes (n &lt; 50)</li>
<li>Non-convergent models</li>
<li>Singular covariance matrices</li>
<li>Missing data</li>
<li>Zero effects</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="test-organization">Test Organization<a class="anchor" aria-label="anchor" href="#test-organization"></a></h3>
<pre><code>tests/testthat/
├── helper-test-data.R      # Test data generators
├── test-classes.R          # S7 class validation
├── test-extract-lm.R       # lm/glm extraction
├── test-extract-lavaan.R   # lavaan extraction
├── test-fit-glm.R          # GLM fitting
├── test-bootstrap.R        # Bootstrap methods
└── test-utils.R            # Utility functions</code></pre>
</div>
<div class="section level3">
<h3 id="coverage-expectations">Coverage Expectations<a class="anchor" aria-label="anchor" href="#coverage-expectations"></a></h3>
<ul><li>
<strong>Target</strong>: &gt;90% overall coverage</li>
<li>
<strong>Critical paths</strong>: 100% coverage
<ul><li>S7 class definitions</li>
<li>Core extraction functions</li>
<li>Bootstrap methods</li>
</ul></li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="integration-with-dependent-packages">Integration with Dependent Packages<a class="anchor" aria-label="anchor" href="#integration-with-dependent-packages"></a></h2>
<div class="section level3">
<h3 id="probmed-integration">probmed Integration<a class="anchor" aria-label="anchor" href="#probmed-integration"></a></h3>
<p><strong>probmed will</strong>: - Import medfit - Replace extraction code with <code><a href="reference/extract_mediation.html">medfit::extract_mediation()</a></code> - Replace bootstrap code with <code><a href="reference/bootstrap_mediation.html">medfit::bootstrap_mediation()</a></code> - Keep its formula interface as wrapper around medfit - Add P_med-specific computation</p>
<p><strong>Backward compatibility critical</strong>: probmed users should see no changes</p>
</div>
<div class="section level3">
<h3 id="rmediation-integration">RMediation Integration<a class="anchor" aria-label="anchor" href="#rmediation-integration"></a></h3>
<p><strong>RMediation will</strong>: - Import medfit - Replace extraction code with <code><a href="reference/extract_mediation.html">medfit::extract_mediation()</a></code> - Optionally use bootstrap utilities - Keep its unique methods (DOP, MBCO, MC)</p>
</div>
<div class="section level3">
<h3 id="medrobust-integration">medrobust Integration<a class="anchor" aria-label="anchor" href="#medrobust-integration"></a></h3>
<p><strong>medrobust will</strong>: - Suggest medfit (optional) - Optionally use for naive estimates - Keep its unique methods (bounds, falsification)</p>
</div>
<div class="section level3">
<h3 id="coordination">Coordination<a class="anchor" aria-label="anchor" href="#coordination"></a></h3>
<p><strong>When making changes that affect</strong>: - S7 class structure → Coordinate with all packages - Extraction API → Coordinate with probmed and RMediation - Bootstrap API → Coordinate with all packages</p>
<p><strong>Versioning</strong>: - Use semantic versioning - Breaking changes → major version bump - New features → minor version bump - Bug fixes → patch version bump</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="development-roadmap">Development Roadmap<a class="anchor" aria-label="anchor" href="#development-roadmap"></a></h2>
<p>See <code>planning/medfit-roadmap.md</code> for detailed implementation plan.</p>
<div class="section level3">
<h3 id="current-phase-mvp-development">Current Phase: MVP Development<a class="anchor" aria-label="anchor" href="#current-phase-mvp-development"></a></h3>
<ul class="task-list"><li><label><input type="checkbox" checked>Package skeleton</label></li>
<li><label><input type="checkbox">S7 classes implemented</label></li>
<li><label><input type="checkbox">Extraction methods (lm/glm, lavaan)</label></li>
<li><label><input type="checkbox">Fitting API (GLM engine)</label></li>
<li><label><input type="checkbox">Bootstrap infrastructure</label></li>
<li><label><input type="checkbox">Comprehensive tests</label></li>
<li><label><input type="checkbox">Documentation and vignettes</label></li>
</ul></div>
<div class="section level3">
<h3 id="future-enhancements">Future Enhancements<a class="anchor" aria-label="anchor" href="#future-enhancements"></a></h3>
<ul class="task-list"><li><label><input type="checkbox">lmer engine (mixed models)</label></li>
<li><label><input type="checkbox">brms engine (Bayesian)</label></li>
<li><label><input type="checkbox">Additional extraction methods</label></li>
<li><label><input type="checkbox">Performance optimizations</label></li>
<li><label><input type="checkbox">Extended documentation</label></li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="statistical-assumptions">Statistical Assumptions<a class="anchor" aria-label="anchor" href="#statistical-assumptions"></a></h2>
<div class="section level3">
<h3 id="key-assumptions-for-inference">Key Assumptions for Inference<a class="anchor" aria-label="anchor" href="#key-assumptions-for-inference"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Correct model specification</strong>
<ul><li>Mediator model correctly specified</li>
<li>Outcome model correctly specified</li>
<li>Appropriate family/link functions</li>
</ul></li>
<li>
<strong>Parameter normality</strong> (for parametric bootstrap)
<ul><li>(θ̂) ~ N(θ, Σ)</li>
<li>Generally holds for large n (CLT)</li>
<li>Check with Q-Q plots</li>
</ul></li>
<li>
<strong>No unmeasured confounding</strong> (for causal interpretation)
<ul><li>Standard causal mediation assumptions</li>
<li>Not testable, requires subject-matter knowledge</li>
<li>
<strong>Note</strong>: medfit computes statistics; causal interpretation is user’s responsibility</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="diagnostics">Diagnostics<a class="anchor" aria-label="anchor" href="#diagnostics"></a></h3>
<p>Users should: - Check bootstrap distributions (histograms, Q-Q plots) - Verify model convergence - Assess residual plots - Consider sensitivity analyses</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="common-pitfalls-to-avoid">Common Pitfalls to Avoid<a class="anchor" aria-label="anchor" href="#common-pitfalls-to-avoid"></a></h2>
<ol style="list-style-type: decimal"><li>
<strong>Don’t mix up variable names</strong>: Ensure treatment/mediator names match model</li>
<li>
<strong>Don’t ignore convergence warnings</strong>: Check <code>converged</code> property</li>
<li>
<strong>Don’t use plugin for inference</strong>: Always bootstrap for CIs</li>
<li>
<strong>Don’t skip input validation</strong>: Use validators rigorously</li>
<li>
<strong>Don’t break backward compatibility</strong>: Coordinate with dependent packages</li>
</ol><hr></div>
<div class="section level2">
<h2 id="key-mathematical-formulas">Key Mathematical Formulas<a class="anchor" aria-label="anchor" href="#key-mathematical-formulas"></a></h2>
<div class="section level3">
<h3 id="indirect-effect">Indirect Effect<a class="anchor" aria-label="anchor" href="#indirect-effect"></a></h3>
<p>For simple mediation (X → M → Y):</p>
<pre><code>Indirect effect = a × b</code></pre>
<p>where: - a = effect of X on M - b = effect of M on Y (controlling for X)</p>
</div>
<div class="section level3">
<h3 id="parametric-bootstrap">Parametric Bootstrap<a class="anchor" aria-label="anchor" href="#parametric-bootstrap"></a></h3>
<p>Sample from:</p>
<pre><code>θ* ~ N(θ̂, Σ̂)</code></pre>
<p>Compute statistic for each θ*, extract quantiles for CI.</p>
</div>
<div class="section level3">
<h3 id="nonparametric-bootstrap">Nonparametric Bootstrap<a class="anchor" aria-label="anchor" href="#nonparametric-bootstrap"></a></h3>
<ol style="list-style-type: decimal"><li>Resample data: D* ~ D (with replacement)</li>
<li>Refit models on D*</li>
<li>Extract θ*</li>
<li>Compute statistic</li>
<li>Repeat, extract quantiles for CI</li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="additional-resources">Additional Resources<a class="anchor" aria-label="anchor" href="#additional-resources"></a></h2>
<div class="section level3">
<h3 id="package-ecosystem-documentation">Package Ecosystem Documentation<a class="anchor" aria-label="anchor" href="#package-ecosystem-documentation"></a></h3>
<ul><li>
<strong>probmed</strong>: <code>probmed/CLAUDE.md</code>, <code>probmed/planning/</code>
</li>
<li>
<strong>RMediation</strong>: <code>rmediation/CLAUDE.md</code>
</li>
<li>
<strong>medrobust</strong>: <code>medrobust/CLAUDE.md</code>
</li>
<li>
<strong>Ecosystem strategy</strong>: <code>probmed/planning/three-package-ecosystem-strategy.md</code>
</li>
</ul></div>
<div class="section level3">
<h3 id="key-planning-documents">Key Planning Documents<a class="anchor" aria-label="anchor" href="#key-planning-documents"></a></h3>
<p>Located in <code>planning/</code>: - <strong>medfit-roadmap.md</strong>: Detailed implementation plan - <strong>ECOSYSTEM.md</strong>: Connection to dependent packages</p>
</div>
<div class="section level3">
<h3 id="related-packages">Related Packages<a class="anchor" aria-label="anchor" href="#related-packages"></a></h3>
<ul><li>probmed: <a href="https://github.com/data-wise/probmed" class="external-link uri">https://github.com/data-wise/probmed</a>
</li>
<li>RMediation: <a href="https://github.com/data-wise/rmediation" class="external-link uri">https://github.com/data-wise/rmediation</a>
</li>
<li>medrobust: <a href="https://github.com/data-wise/medrobust" class="external-link uri">https://github.com/data-wise/medrobust</a>
</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a></h2>
<div class="section level3">
<h3 id="lavaan-dispatch-issues">lavaan Dispatch Issues<a class="anchor" aria-label="anchor" href="#lavaan-dispatch-issues"></a></h3>
<p>If <code><a href="reference/extract_mediation.html">extract_mediation()</a></code> doesn’t work with lavaan objects: - Check that lavaan is installed - Verify <code>.onLoad()</code> is registering the method - Test with <code>methods(extract_mediation)</code> to see registered methods</p>
</div>
<div class="section level3">
<h3 id="bootstrap-reproducibility">Bootstrap Reproducibility<a class="anchor" aria-label="anchor" href="#bootstrap-reproducibility"></a></h3>
<p>If bootstrap results not reproducible: - Ensure seed is set before calling - Check that parallel=FALSE or seed is set before parallel call - Verify n_boot is the same</p>
</div>
<div class="section level3">
<h3 id="performance-issues">Performance Issues<a class="anchor" aria-label="anchor" href="#performance-issues"></a></h3>
<p>If bootstrap is slow: - Use <code>parallel=TRUE</code> - Consider parametric instead of nonparametric - Reduce <code>n_boot</code> for testing (use 1000+ for production)</p>
<hr><p><strong>Last Updated</strong>: 2025-12-02 <strong>Maintained by</strong>: medfit development team</p>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Davood Tofighi.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

