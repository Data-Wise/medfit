---
title: "Bootstrap Inference"
format: html
execute:
  collapse: true
  comment: "#>"
  eval: true
---

```{r}
#| label: setup
#| include: false
library(medfit)
```

## Overview

Bootstrap inference provides confidence intervals for indirect effects without assuming normality. medfit implements three bootstrap methods:

1. **Parametric bootstrap**: Sample from parameter distribution (fast, assumes normality)
2. **Nonparametric bootstrap**: Resample data and refit models (robust, slower)
3. **Plugin estimator**: Point estimate only (fastest, no CI)

All methods return a `BootstrapResult` object with consistent structure.

## Why Bootstrap for Mediation?

The sampling distribution of indirect effects ($a \times b$) is typically:

- **Non-normal**: Even when a and b are normal, their product is not
- **Skewed**: Often right-skewed
- **Complex**: No closed-form distribution for general case

Bootstrap methods:
- Don't assume normality
- Provide accurate coverage (closer to nominal 95%)
- Handle complex indirect effects (serial mediation, moderated mediation)

## Setup: Create Mediation Data

First, let's create some example data and fit a mediation model:

```{r}
#| label: setup-data
# Generate example data
set.seed(123)
n <- 200
X <- rnorm(n)
M <- 0.5 * X + rnorm(n)
Y <- 0.3 * M + 0.2 * X + rnorm(n)
data <- data.frame(X = X, M = M, Y = Y)

# Fit mediation model
med <- fit_mediation(
  formula_y = Y ~ X + M,
  formula_m = M ~ X,
  data = data,
  treatment = "X",
  mediator = "M"
)

print(med)
```

## Defining the Statistic Function

Bootstrap methods require a function that computes the statistic of interest from parameters:

```{r}
#| label: statistic-fn
# Define indirect effect function
# theta is a named vector with parameters from mediation model
indirect_fn <- function(theta) {
  theta["m_X"] * theta["y_M"]  # a * b
}

# Test it with current estimates
indirect_fn(med@estimates)
```

## Parametric Bootstrap

Samples from the estimated parameter distribution:

```{r}
#| label: parametric
# Parametric bootstrap
boot_result <- bootstrap_mediation(
  statistic_fn = indirect_fn,
  method = "parametric",
  mediation_data = med,
  n_boot = 1000,
  ci_level = 0.95,
  seed = 123
)

print(boot_result)
```

### How It Works

1. Extract parameter estimates: $\hat{\theta} = (\hat{a}, \hat{b}, ...)$
2. Extract covariance matrix: $\hat{\Sigma}$
3. For each bootstrap iteration $i = 1, ..., B$:
   - Sample $\theta^*_i \sim N(\hat{\theta}, \hat{\Sigma})$
   - Compute indirect effect: $IE^*_i = a^*_i \times b^*_i$
4. Compute percentile CI from bootstrap distribution

### When to Use

- **Fast**: No model refitting required
- **Appropriate when**: Parameters are approximately normal (large n)
- **Inappropriate when**: Small samples, non-normal parameters

### Advantages

- Very fast (no refitting)
- Reproducible with seed
- Works with extracted models (no need for original data)

### Disadvantages

- Assumes multivariate normality of parameters
- May underestimate uncertainty in small samples

## Nonparametric Bootstrap

Resamples data and refits models:

```{r}
#| label: nonparametric
# Nonparametric bootstrap (requires original data in mediation object)
boot_np <- bootstrap_mediation(
  statistic_fn = indirect_fn,
  method = "nonparametric",
  mediation_data = med,
  n_boot = 500,  # Fewer iterations for speed
  ci_level = 0.95,
  seed = 123
)

print(boot_np)
```

### How It Works

1. For each bootstrap iteration $i = 1, ..., B$:
   - Resample data with replacement: $D^*_i$
   - Refit mediator model on $D^*_i$
   - Refit outcome model on $D^*_i$
   - Extract paths: $a^*_i$, $b^*_i$
   - Compute indirect effect: $IE^*_i = a^*_i \times b^*_i$
2. Compute percentile CI from bootstrap distribution

### When to Use

- **Robust**: Makes no parametric assumptions
- **Appropriate when**: Small samples, non-normal data, GLMs
- **Gold standard**: Most widely accepted method

### Advantages

- No distributional assumptions
- Robust to outliers
- Captures full sampling variability

### Disadvantages

- Computationally intensive (refits models B times)
- Requires original data
- Can be slow for complex models

### Parallel Processing

Speed up with parallel processing (Unix systems):

```{r}
#| label: parallel
#| eval: false
# Run in parallel (Unix only)
boot_parallel <- bootstrap_mediation(
  statistic_fn = indirect_fn,
  method = "nonparametric",
  mediation_data = med,
  n_boot = 5000,
  parallel = TRUE,
  ncores = 4,
  seed = 123
)
```

## Plugin Estimator

Point estimate only, no confidence interval:

```{r}
#| label: plugin
# Plugin estimator (fastest)
plugin_result <- bootstrap_mediation(
  statistic_fn = indirect_fn,
  method = "plugin",
  mediation_data = med
)

print(plugin_result)
```

### When to Use

- Quick checks
- Point estimates for simulation studies
- When CI is not needed

### How It Works

Simply computes the statistic from the fitted model parameters. No resampling.

## Interpreting Results

### Bootstrap Distribution

The bootstrap distribution shows the sampling variability:

```{r}
#| label: distribution
# Access bootstrap estimates
boot_estimates <- boot_result@boot_estimates

# Histogram
hist(
  boot_estimates,
  breaks = 30,
  main = "Bootstrap Distribution of Indirect Effect",
  xlab = "Indirect Effect (a * b)",
  col = "lightblue"
)

# Add percentile CI
abline(v = boot_result@ci_lower, col = "red", lwd = 2)
abline(v = boot_result@ci_upper, col = "red", lwd = 2)
abline(v = boot_result@estimate, col = "blue", lwd = 2)
legend("topright",
       legend = c("Point estimate", "95% CI"),
       col = c("blue", "red"), lwd = 2)
```

### Confidence Interval

The percentile bootstrap CI is computed as:

- Lower bound: 2.5th percentile (for 95% CI)
- Upper bound: 97.5th percentile (for 95% CI)

```{r}
#| label: ci
# 95% CI
c(boot_result@ci_lower, boot_result@ci_upper)

# Change confidence level
boot_90 <- bootstrap_mediation(
  statistic_fn = indirect_fn,
  method = "parametric",
  mediation_data = med,
  n_boot = 1000,
  ci_level = 0.90,
  seed = 123
)
c(boot_90@ci_lower, boot_90@ci_upper) # Narrower
```

### Statistical Significance

If the confidence interval excludes zero, the indirect effect is statistically significant:

```{r}
#| label: significance
# Check if CI excludes zero
if (boot_result@ci_lower > 0 || boot_result@ci_upper < 0) {
  cat("Indirect effect is statistically significant\n")
} else {
  cat("Indirect effect is not statistically significant\n")
}

# Effect size and CI
cat(sprintf("Indirect effect: %.3f [%.3f, %.3f]\n",
            boot_result@estimate, boot_result@ci_lower, boot_result@ci_upper))
```

## Custom Statistics

You can bootstrap any function of the parameters:

```{r}
#| label: custom
# Total effect = c' + a*b
total_fn <- function(theta) {
  theta["y_X"] + theta["m_X"] * theta["y_M"]
}

boot_total <- bootstrap_mediation(
  statistic_fn = total_fn,
  method = "parametric",
  mediation_data = med,
  n_boot = 1000,
  seed = 123
)

cat("Total effect:", boot_total@estimate,
    "[", boot_total@ci_lower, ",", boot_total@ci_upper, "]\n")

# Proportion mediated = (a*b) / (c' + a*b)
prop_fn <- function(theta) {
  indirect <- theta["m_X"] * theta["y_M"]
  total <- theta["y_X"] + indirect
  indirect / total
}

boot_prop <- bootstrap_mediation(
  statistic_fn = prop_fn,
  method = "parametric",
  mediation_data = med,
  n_boot = 1000,
  seed = 123
)

cat("Proportion mediated:", boot_prop@estimate,
    "[", boot_prop@ci_lower, ",", boot_prop@ci_upper, "]\n")
```

## Reproducibility

Set a seed for reproducible results:

```{r}
#| label: seed
# Same seed = same results
boot1 <- bootstrap_mediation(
  statistic_fn = indirect_fn,
  method = "parametric",
  mediation_data = med,
  n_boot = 1000,
  seed = 123
)
boot2 <- bootstrap_mediation(
  statistic_fn = indirect_fn,
  method = "parametric",
  mediation_data = med,
  n_boot = 1000,
  seed = 123
)

# Identical results
all.equal(boot1@boot_estimates, boot2@boot_estimates)

# Different seed = different results
boot3 <- bootstrap_mediation(
  statistic_fn = indirect_fn,
  method = "parametric",
  mediation_data = med,
  n_boot = 1000,
  seed = 456
)
all.equal(boot1@boot_estimates, boot3@boot_estimates)
```

## How Many Bootstrap Samples?

General guidelines:

- **Exploratory**: 1000 samples (fast)
- **Publication**: 5000+ samples (stable CI)
- **High stakes**: 10,000+ samples (very stable)

Check stability by varying `n_boot`:

```{r}
#| label: n-boot
# Compare different n_boot
boot_1k <- bootstrap_mediation(
  statistic_fn = indirect_fn,
  method = "parametric",
  mediation_data = med,
  n_boot = 1000,
  seed = 123
)
boot_5k <- bootstrap_mediation(
  statistic_fn = indirect_fn,
  method = "parametric",
  mediation_data = med,
  n_boot = 5000,
  seed = 123
)

# Compare CIs
rbind(
  "1K" = c(boot_1k@ci_lower, boot_1k@ci_upper),
  "5K" = c(boot_5k@ci_lower, boot_5k@ci_upper)
)
```

If CIs are similar, n_boot is sufficient.

## Comparison with Delta Method

The delta method provides asymptotic SE for indirect effects:

```{r}
#| label: delta
# Delta method SE
a <- med@a_path
b <- med@b_path
var_a <- med@vcov["m_X", "m_X"]
var_b <- med@vcov["y_M", "y_M"]

# a and b are from different models, so Cov(a,b) = 0
se_delta <- sqrt(b^2 * var_a + a^2 * var_b)

# Delta method 95% CI (assumes normality)
ci_delta <- med@a_path * med@b_path + c(-1.96, 1.96) * se_delta

# Compare with bootstrap
ci_boot <- c(boot_result@ci_lower, boot_result@ci_upper)

comparison <- rbind(
  "Delta method" = ci_delta,
  "Bootstrap" = ci_boot
)
colnames(comparison) <- c("Lower", "Upper")
comparison
```

Bootstrap is generally preferred because it:
- Doesn't assume normality of indirect effect
- Handles skewness correctly
- Provides better coverage

## Best Practices

1. **Choose method appropriately**:
   - Parametric: Large samples, normal data
   - Nonparametric: Small samples, non-normal data, GLMs
   - Plugin: Quick checks only

2. **Set seed**: Always set seed for reproducibility

3. **Use enough bootstraps**: At least 1000, preferably 5000+

4. **Check convergence**: Ensure models converged on bootstrap samples

5. **Visualize distribution**: Plot histogram and Q-Q plot

6. **Use parallel processing**: For nonparametric with large B

## Next Steps

- See [introduction](introduction.html) for S7 class details
- Learn about [model extraction](extraction.html)
- Check reference documentation for `bootstrap_mediation()`

## Development Status

Currently implemented:
- ✅ BootstrapResult S7 class
- ✅ Parametric bootstrap
- ✅ Nonparametric bootstrap
- ✅ Plugin estimator
- ✅ Parallel processing support (Unix)

See `NEWS.md` for updates.
