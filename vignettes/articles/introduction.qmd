---
title: "Introduction to medfit"
format: html
execute:
  collapse: true
  comment: "#>"
  eval: true
---

```{r}
#| label: setup
#| include: false
library(medfit)
```

## Overview

**medfit** provides unified infrastructure for mediation analysis in R. It offers:

- **S7-based classes** for standardized mediation data structures
- **Generic functions** for model fitting, extraction, and inference
- **Foundation** for the mediation analysis ecosystem (probmed, RMediation, medrobust)

The package eliminates code duplication across mediation packages by providing shared infrastructure while allowing each package to focus on its unique methodological contributions.

## Core S7 Classes

medfit defines three main S7 classes to represent mediation structures:

### MediationData

Stores simple mediation models (X -> M -> Y):

```{r}
#| label: mediation-data
# Create a MediationData object directly
med_data <- MediationData(
  a_path = 0.5,           # X -> M effect
  b_path = 0.3,           # M -> Y effect (controlling for X)
  c_prime = 0.2,          # X -> Y direct effect
  treatment = "X",
  mediator = "M",
  outcome = "Y",
  estimates = c(m_intercept = 0, m_X = 0.5, y_intercept = 0, y_X = 0.2, y_M = 0.3),
  vcov = diag(5) * 0.01,
  sigma_m = 1.0,
  sigma_y = 1.0,
  mediator_predictors = "X",
  outcome_predictors = c("X", "M"),
  n_obs = 100L,
  converged = TRUE,
  source_package = "medfit"
)

# Print method shows key information
print(med_data)
```

The indirect effect is computed as `a * b`:

```{r}
#| label: indirect-effect
# Access path coefficients
med_data@a_path
med_data@b_path

# Indirect effect
med_data@a_path * med_data@b_path
```

### SerialMediationData

Stores serial mediation models (X -> M1 -> M2 -> ... -> Y):

```{r}
#| label: serial-mediation
# Example: Two-mediator serial mediation (X -> M1 -> M2 -> Y)
serial_data <- SerialMediationData(
  a_path = 0.4,           # X -> M1
  d_path = 0.5,           # M1 -> M2 (scalar for 2 mediators)
  b_path = 0.3,           # M2 -> Y
  c_prime = 0.2,          # X -> Y direct effect
  treatment = "X",
  mediators = c("M1", "M2"),
  outcome = "Y",
  estimates = c(a = 0.4, d = 0.5, b = 0.3, c_prime = 0.2),
  vcov = diag(4) * 0.01,
  sigma_mediators = c(1.0, 1.0),
  sigma_y = 1.0,
  mediator_predictors = list(M1 = "X", M2 = c("X", "M1")),
  outcome_predictors = c("X", "M1", "M2"),
  n_obs = 100L,
  converged = TRUE,
  source_package = "medfit"
)

print(serial_data)
```

For two mediators, the serial indirect effect is `a * d * b`:

```{r}
#| label: serial-indirect
# Serial indirect effect (product-of-three)
serial_data@a_path * serial_data@d_path * serial_data@b_path
```

**Design for extensibility**: For 3+ mediators, `d_path` becomes a vector:
- 3 mediators: `a * d21 * d32 * b` (product-of-four)
- k mediators: product-of-(k+1)

### BootstrapResult

Stores bootstrap inference results:

```{r}
#| label: bootstrap-result
# Example: Bootstrap result for indirect effect
boot_result <- BootstrapResult(
  estimate = 0.15,        # Point estimate (a * b)
  ci_lower = 0.08,        # Lower CI bound
  ci_upper = 0.25,        # Upper CI bound
  ci_level = 0.95,        # Confidence level
  boot_estimates = rnorm(1000, mean = 0.15, sd = 0.04),  # Bootstrap distribution
  n_boot = 1000L,
  method = "parametric",
  converged = TRUE
)

print(boot_result)
```

## Main Functions

medfit provides three main functions that work across different model types:

### fit_mediation()

Fit mediation models directly with a formula interface:

```{r}
#| label: fit-example
# Generate example data
set.seed(123)
n <- 200
X <- rnorm(n)
M <- 0.5 * X + rnorm(n)
Y <- 0.3 * M + 0.2 * X + rnorm(n)
data <- data.frame(X = X, M = M, Y = Y)

# Fit mediation model
med <- fit_mediation(
  formula_y = Y ~ X + M,
  formula_m = M ~ X,
  data = data,
  treatment = "X",
  mediator = "M"
)

print(med)
```

### extract_mediation()

Extract mediation structure from fitted models:

```{r}
#| label: extract-example
# From lm/glm models
model_m <- lm(M ~ X, data = data)
model_y <- lm(Y ~ X + M, data = data)

med_extracted <- extract_mediation(
  model_m,             # Mediator model
  model_y = model_y,   # Outcome model
  treatment = "X",
  mediator = "M"
)

print(med_extracted)
```

For lavaan SEM models (requires lavaan package):
```{r}
#| label: extract-lavaan
#| eval: false
library(lavaan)

# Fit lavaan model
model_syntax <- "
  M ~ X
  Y ~ M + X
"
fit <- sem(model_syntax, data = data)

# Extract mediation structure
med_lavaan <- extract_mediation(
  fit,
  treatment = "X",
  mediator = "M",
  outcome = "Y"
)
```

See `vignette("extraction")` for details.

### bootstrap_mediation()

Perform bootstrap inference on indirect effects:

```{r}
#| label: bootstrap-example
# Define indirect effect function
indirect_fn <- function(theta) {
  theta["m_X"] * theta["y_M"]
}

# Parametric bootstrap
boot_result <- bootstrap_mediation(
  statistic_fn = indirect_fn,
  method = "parametric",
  mediation_data = med,
  n_boot = 1000,
  ci_level = 0.95,
  seed = 123
)

print(boot_result)
```

Three methods available:
- **parametric**: Samples from N(theta-hat, Sigma-hat) - fast, assumes normality
- **nonparametric**: Resamples data and refits models - robust, slower
- **plugin**: Point estimate only - fastest, no CI

See `vignette("bootstrap")` for details.

## Package Ecosystem

medfit serves as the foundation for specialized mediation packages:

- **probmed**: Probabilistic mediation effect size (P_med)
  - Uses medfit for infrastructure
  - Adds P_med computation and visualization

- **RMediation**: Confidence intervals via distribution methods
  - Uses medfit for extraction
  - Adds Distribution of Product (DOP), MBCO tests

- **medrobust**: Sensitivity analysis
  - Uses medfit for baseline estimates
  - Adds bounds computation, falsification tests

## Design Principles

1. **Type safety**: S7 classes with validators ensure data integrity
2. **Consistency**: Standardized interfaces across model types
3. **Extensibility**: Easy to add new model engines and methods
4. **Minimal dependencies**: Core functionality with minimal external dependencies
5. **Infrastructure focus**: Provides tools, not effect sizes

## Next Steps

- Learn about [model extraction](extraction.html) from different sources
- Explore [bootstrap inference methods](bootstrap.html)
- See the reference documentation for detailed API information

## Development Status

medfit is in Phase 6 (Extended Testing):

- âœ… Phase 1-2: S7 class architecture
- âœ… Phase 3: Model extraction (lm/glm, lavaan)
- âœ… Phase 4: Model fitting (GLM engine)
- âœ… Phase 5: Bootstrap infrastructure
- âœ… Phase 6: Extended testing
- ðŸ“‹ Phase 7: Polish & release

See `NEWS.md` for the latest updates.
