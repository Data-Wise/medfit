---
title: "Model Extraction"
format: html
execute:
  collapse: true
  comment: "#>"
  eval: false
---

## Overview

The `extract_mediation()` function provides a standardized interface for extracting mediation structures from fitted models. It works with:
- **lm/glm** models (base R)
- **lavaan** SEM models (planned)
- **lmer** mixed models (future)

Note: OpenMx extraction is planned for a future release.

All extraction methods return a `MediationData` or `SerialMediationData` object, ensuring consistency across modeling frameworks.

## Extraction Pattern

All extraction methods follow this pattern:

1. Validate inputs (check variable names exist)
2. Extract path coefficients (a, b, c' paths)
3. Extract covariance matrix (for inference)
4. Extract residual variances (if Gaussian)
5. Retrieve data (if available)
6. Create MediationData object
7. Return standardized structure

## Extracting from lm/glm Models

### Simple Mediation

For simple mediation (X -> M -> Y), fit two models:

```{r}
#| label: lm-simple
# Generate example data
set.seed(123)
n <- 200
X <- rnorm(n)
M <- 0.5 * X + rnorm(n, sd = 0.8)
Y <- 0.3 * M + 0.2 * X + rnorm(n, sd = 0.8)
data <- data.frame(X = X, M = M, Y = Y)

# Fit mediation models
model_m <- lm(M ~ X, data = data)
model_y <- lm(Y ~ X + M, data = data)

# Extract mediation structure
med <- extract_mediation(
  model_m,           # Mediator model
  model_y,           # Outcome model
  treatment = "X",
  mediator = "M"
)

# View results
print(med)
summary(med)

# Indirect effect
med@a_path * med@b_path
```

### What Gets Extracted?

The extraction captures:

- **Path coefficients**:
  - `a_path`: Coefficient of X in mediator model (X -> M)
  - `b_path`: Coefficient of M in outcome model (M -> Y, controlling for X)
  - `c_prime`: Coefficient of X in outcome model (direct effect)

- **Full parameter vector**: All coefficients from both models

- **Covariance matrix**: For computing standard errors of functions of parameters

- **Residual variances**: `sigma_m^2` and `sigma_y^2` for Gaussian models

- **Data and metadata**: Sample size, variable names, convergence status

### GLM with Non-Normal Outcomes

Works with any GLM family:

```{r}
#| label: glm-binary
# Binary outcome
Y_binary <- rbinom(n, 1, prob = plogis(0.3 * M + 0.2 * X))
data$Y_binary <- Y_binary

model_m <- lm(M ~ X, data = data)
model_y <- glm(Y_binary ~ X + M, data = data, family = binomial())

med <- extract_mediation(
  model_m,
  model_y,
  treatment = "X",
  mediator = "M"
)

# Note: b_path and c_prime are on logit scale
print(med)
```

### Controlling for Covariates

Include covariates in both models:

```{r}
#| label: covariates
# Add covariates
data$Z1 <- rnorm(n)
data$Z2 <- rnorm(n)

model_m <- lm(M ~ X + Z1 + Z2, data = data)
model_y <- lm(Y ~ X + M + Z1 + Z2, data = data)

med <- extract_mediation(
  model_m,
  model_y,
  treatment = "X",
  mediator = "M"
)

# Path coefficients adjust for Z1 and Z2
print(med)
```

## Extracting from lavaan Models

### Simple Mediation in SEM

```{r}
#| label: lavaan-simple
library(lavaan)

# Define SEM model
model_syntax <- "
  # Mediator model
  M ~ a * X

  # Outcome model
  Y ~ b * M + c_prime * X

  # Indirect effect
  indirect := a * b

  # Total effect
  total := c_prime + a * b
"

# Fit model
fit <- sem(model_syntax, data = data)

# Extract mediation structure
med <- extract_mediation(
  fit,
  treatment = "X",
  mediator = "M",
  outcome = "Y"
)

print(med)
```

### Serial Mediation in SEM

For serial mediation (X -> M1 -> M2 -> Y):

```{r}
#| label: lavaan-serial
# Generate serial mediation data
M1 <- 0.4 * X + rnorm(n, sd = 0.8)
M2 <- 0.5 * M1 + 0.2 * X + rnorm(n, sd = 0.8)
Y_serial <- 0.3 * M2 + 0.1 * M1 + 0.2 * X + rnorm(n, sd = 0.8)
data_serial <- data.frame(X = X, M1 = M1, M2 = M2, Y = Y_serial)

# Define serial mediation model
serial_syntax <- "
  # First mediator
  M1 ~ a * X

  # Second mediator
  M2 ~ d * M1 + X

  # Outcome
  Y ~ b * M2 + M1 + c_prime * X

  # Serial indirect effect (product-of-three)
  serial_indirect := a * d * b
"

fit_serial <- sem(serial_syntax, data = data_serial)

# Extract as SerialMediationData
med_serial <- extract_mediation(
  fit_serial,
  treatment = "X",
  mediators = c("M1", "M2"),
  outcome = "Y"
)

print(med_serial)

# Serial indirect effect
med_serial@a_path * med_serial@d_path * med_serial@b_path
```

## Compatibility with RMediation

The extraction design is compatible with RMediation's lavaan extractor:

```{r}
#| label: rmediation-compat
# RMediation extracts parameters for Distribution of Product method
# medfit extracts the same structure but as S7 classes

# Both packages can work with the same fitted models
# medfit provides infrastructure, RMediation adds DOP/MBCO methods
```

## Error Handling

The extraction validates inputs:

```{r}
#| label: error-handling
# Variable not in model
extract_mediation(
  model_m,
  model_y,
  treatment = "NonExistent",
  mediator = "M"
)
# Error: Treatment variable 'NonExistent' not found in model

# Mediator not in outcome model
model_y_wrong <- lm(Y ~ X, data = data)  # Missing M
extract_mediation(
  model_m,
  model_y_wrong,
  treatment = "X",
  mediator = "M"
)
# Error: Mediator variable 'M' not found in outcome model
```

## Advanced Topics

### Extracting Full Parameter Vector

The `estimates` property contains all parameters from both models:

```{r}
#| label: full-params
med <- extract_mediation(model_m, model_y, treatment = "X", mediator = "M")

# All parameters (intercepts + coefficients)
med@estimates

# Access by name
med@estimates["a"]  # a_path
med@estimates["b"]  # b_path
```

### Covariance Matrix for Delta Method

Use the covariance matrix for computing standard errors:

```{r}
#| label: vcov
# Covariance matrix of all parameters
vcov_mat <- med@vcov

# For delta method SE of indirect effect (a*b):
# Var(ab) = b^2 * Var(a) + a^2 * Var(b) + 2ab*Cov(a,b)

a <- med@a_path
b <- med@b_path
var_a <- vcov_mat["a", "a"]
var_b <- vcov_mat["b", "b"]
cov_ab <- vcov_mat["a", "b"]

var_indirect <- b^2 * var_a + a^2 * var_b + 2 * a * b * cov_ab
se_indirect <- sqrt(var_indirect)

se_indirect
```

## Design for Extensibility

The extraction system is designed to accommodate future extensions:

- **New model types**: Add methods for lmer, brms, etc.
- **Complex mediation**: Multiple mediators, moderated mediation
- **Multiple treatments**: Comparative mediation analysis
- **Latent variables**: SEM with measurement models

All methods return the same S7 class structure, ensuring consistency.

## Next Steps

- Learn about [bootstrap inference](bootstrap.html) on extracted models
- See the [introduction](introduction.html) for S7 class details
- Check the reference documentation for `extract_mediation()` methods

## Development Status

Currently implemented:
- âœ… S7 class definitions (MediationData, SerialMediationData)
- ðŸš§ lm/glm extraction (in development)
- ðŸ“‹ lavaan extraction (planned)

**Note**: OpenMx extraction has been postponed to a future release.

See `NEWS.md` for updates.
