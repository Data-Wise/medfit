---
title: "Model Extraction"
format: html
execute:
  collapse: true
  comment: "#>"
  eval: true
---

```{r}
#| label: setup
#| include: false
library(medfit)
```

## Overview

The `extract_mediation()` function provides a standardized interface for extracting mediation structures from fitted models. It works with:

- **lm/glm** models (base R) âœ…
- **lavaan** SEM models âœ…
- **OpenMx** models (future)
- **lmer** mixed models (future)

All extraction methods return a `MediationData` object, ensuring consistency across modeling frameworks.

## Extraction Pattern

All extraction methods follow this pattern:

1. Validate inputs (check variable names exist)
2. Extract path coefficients (a, b, c' paths)
3. Extract covariance matrix (for inference)
4. Extract residual variances (if Gaussian)
5. Retrieve data (if available)
6. Create MediationData object
7. Return standardized structure

## Extracting from lm/glm Models

### Simple Mediation

For simple mediation (X -> M -> Y), fit two models:

```{r}
#| label: lm-simple
# Generate example data
set.seed(123)
n <- 200
X <- rnorm(n)
M <- 0.5 * X + rnorm(n, sd = 0.8)
Y <- 0.3 * M + 0.2 * X + rnorm(n, sd = 0.8)
data <- data.frame(X = X, M = M, Y = Y)

# Fit mediation models
model_m <- lm(M ~ X, data = data)
model_y <- lm(Y ~ X + M, data = data)

# Extract mediation structure
med <- extract_mediation(
  model_m,             # Mediator model (first argument)
  model_y = model_y,   # Outcome model
  treatment = "X",
  mediator = "M"
)

# View results
print(med)
```

### What Gets Extracted?

The extraction captures:

- **Path coefficients**:
  - `a_path`: Coefficient of X in mediator model (X -> M)
  - `b_path`: Coefficient of M in outcome model (M -> Y, controlling for X)
  - `c_prime`: Coefficient of X in outcome model (direct effect)

- **Full parameter vector**: All coefficients from both models with prefixed names (`m_` for mediator model, `y_` for outcome model)

- **Covariance matrix**: Block-diagonal matrix for computing standard errors of functions of parameters

- **Residual variances**: `sigma_m` and `sigma_y` for Gaussian models

- **Data and metadata**: Sample size, variable names, convergence status

```{r}
#| label: extracted-info
# Access path coefficients
cat("a path (X -> M):", med@a_path, "\n")
cat("b path (M -> Y):", med@b_path, "\n")
cat("c' path (X -> Y direct):", med@c_prime, "\n")

# Indirect effect
cat("Indirect effect (a * b):", med@a_path * med@b_path, "\n")

# All parameter names
names(med@estimates)

# Sample size
med@n_obs
```

### GLM with Non-Normal Outcomes

Works with any GLM family:

```{r}
#| label: glm-binary
# Binary outcome
set.seed(456)
Y_binary <- rbinom(n, 1, prob = plogis(0.3 * M + 0.2 * X))
data$Y_binary <- Y_binary

model_m <- lm(M ~ X, data = data)
model_y <- glm(Y_binary ~ X + M, data = data, family = binomial())

med_binary <- extract_mediation(
  model_m,
  model_y = model_y,
  treatment = "X",
  mediator = "M"
)

# Note: b_path and c_prime are on logit scale
print(med_binary)
```

### Controlling for Covariates

Include covariates in both models:

```{r}
#| label: covariates
# Add covariates
data$Z1 <- rnorm(n)
data$Z2 <- rnorm(n)

model_m <- lm(M ~ X + Z1 + Z2, data = data)
model_y <- lm(Y ~ X + M + Z1 + Z2, data = data)

med_cov <- extract_mediation(
  model_m,
  model_y = model_y,
  treatment = "X",
  mediator = "M"
)

# Path coefficients adjust for Z1 and Z2
print(med_cov)

# Covariates appear in predictors
med_cov@mediator_predictors
med_cov@outcome_predictors
```

## Extracting from lavaan Models

### Simple Mediation in SEM

```{r}
#| label: lavaan-simple
#| eval: false
library(lavaan)

# Define SEM model
model_syntax <- "
  # Mediator model
  M ~ a * X

  # Outcome model
  Y ~ b * M + cp * X

  # Indirect effect
  indirect := a * b

  # Total effect
  total := cp + a * b
"

# Fit model
fit <- sem(model_syntax, data = data)

# Extract mediation structure
med_lavaan <- extract_mediation(
  fit,
  treatment = "X",
  mediator = "M",
  outcome = "Y"
)

print(med_lavaan)
```

### Notes on lavaan Extraction

- lavaan models require `outcome` to be specified explicitly
- Path labels (like `a*`, `b*`) are optional but improve clarity
- The method automatically extracts the covariance matrix from lavaan
- Converged status is checked from the lavaan fit

## Comparison: fit_mediation() vs extract_mediation()

Both approaches give the same results:

```{r}
#| label: compare
# Method 1: fit_mediation() - fits and extracts in one step
med1 <- fit_mediation(
  formula_y = Y ~ X + M,
  formula_m = M ~ X,
  data = data,
  treatment = "X",
  mediator = "M"
)

# Method 2: extract_mediation() - extract from existing models
model_m <- lm(M ~ X, data = data)
model_y <- lm(Y ~ X + M, data = data)
med2 <- extract_mediation(model_m, model_y = model_y, treatment = "X", mediator = "M")

# Same results
cat("fit_mediation a_path:", med1@a_path, "\n")
cat("extract_mediation a_path:", med2@a_path, "\n")
```

Use `fit_mediation()` for convenience; use `extract_mediation()` when you need more control over model fitting or want to use non-GLM models.

## Error Handling

The extraction validates inputs:

```{r}
#| label: error-handling
#| error: true
# Variable not in model
model_m <- lm(M ~ X, data = data)
model_y <- lm(Y ~ X + M, data = data)

# This will error: treatment "NonExistent" not found
try(
  extract_mediation(
    model_m,
    model_y = model_y,
    treatment = "NonExistent",
    mediator = "M"
  )
)
```

```{r}
#| label: error-handling-2
#| error: true
# Mediator not in outcome model
model_y_wrong <- lm(Y ~ X, data = data)  # Missing M

# This will error: mediator not in outcome model
try(
  extract_mediation(
    model_m,
    model_y = model_y_wrong,
    treatment = "X",
    mediator = "M"
  )
)
```

## Advanced Topics

### Extracting Full Parameter Vector

The `estimates` property contains all parameters from both models:

```{r}
#| label: full-params
model_m <- lm(M ~ X, data = data)
model_y <- lm(Y ~ X + M, data = data)
med <- extract_mediation(model_m, model_y = model_y, treatment = "X", mediator = "M")

# All parameters (intercepts + coefficients)
med@estimates

# Access by name (using medfit naming convention)
med@estimates["m_X"]   # a_path
med@estimates["y_M"]   # b_path
med@estimates["y_X"]   # c_prime
```

### Covariance Matrix for Delta Method

Use the covariance matrix for computing standard errors:

```{r}
#| label: vcov
# Covariance matrix of all parameters
vcov_mat <- med@vcov

# Dimensions match estimates
dim(vcov_mat)

# For delta method SE of indirect effect (a*b):
# Var(ab) = b^2 * Var(a) + a^2 * Var(b) + 2ab*Cov(a,b)
# Note: a and b are from different models so Cov(a,b) = 0

a <- med@a_path
b <- med@b_path
var_a <- vcov_mat["m_X", "m_X"]
var_b <- vcov_mat["y_M", "y_M"]

var_indirect <- b^2 * var_a + a^2 * var_b
se_indirect <- sqrt(var_indirect)

cat("Delta method SE:", se_indirect, "\n")
cat("95% CI:", med@a_path * med@b_path + c(-1.96, 1.96) * se_indirect, "\n")
```

## Design for Extensibility

The extraction system is designed to accommodate future extensions:

- **New model types**: Add methods for lmer, brms, etc.
- **Complex mediation**: Multiple mediators, moderated mediation
- **Multiple treatments**: Comparative mediation analysis
- **Latent variables**: SEM with measurement models

All methods return the same S7 class structure, ensuring consistency.

## Next Steps

- Learn about [bootstrap inference](bootstrap.html) on extracted models
- See the [introduction](introduction.html) for S7 class details
- Check the reference documentation for `extract_mediation()` methods

## Development Status

Currently implemented:
- âœ… S7 class definitions (MediationData, SerialMediationData)
- âœ… lm/glm extraction
- âœ… lavaan extraction
- ðŸ“‹ OpenMx extraction (future)

See `NEWS.md` for updates.
